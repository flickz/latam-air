if(!Array.prototype.indexOf){Array.prototype.indexOf=function(obj,start){for(var i=(start||0),j=this.length;i<j;i++){if(this[i]===obj){return i;}}return -1;};}function CoUpslPage(){var self=this;this.rightPanel={};if(clientSideData.SO_SITE_FD_DISPLAY_MODE=="0"){clientSideData.PRICE_TYPE="AMOUNT";}else{clientSideData.PRICE_TYPE="AMOUNT_WITHOUT_TAX";}this.fistTimeInUpsl=false;if(clientSideData.IS_FIRST_TIME_ON_UPSL&&self.getSessionCookie("ALPI_VISITED")!=="true"){$.jStorage.deleteKey("outboundPreselected");$.jStorage.deleteKey("inboundPreselected");this.fistTimeInUpsl=true;var outboundTabs=$(".calendarPricesSection.outbound ul");if($(".calendarPricesSection.outbound ul.selected")){self.removeSessionCookie("clickedOutboundTab_");self.setSessionCookie("clickedOutboundTab_"+clientSideData.jSessionId,$(".calendarPricesSection.outbound ul.selected").data("date"));}var inboundTabs=$(".calendarPricesSection.inbound ul");if($(".calendarPricesSection.inbound ul.selected")){self.removeSessionCookie("clickedInboundTab_");self.setSessionCookie("clickedInboundTab_"+clientSideData.jSessionId,$(".calendarPricesSection.inbound ul.selected").data("date"));}}self.removeSessionCookie("ALPI_VISITED");this.mainSection=$("section.main");this.ALPI_FORM=wdk.form("ALPI_FORM",{errorPanel:$("#pageError"),check:function(){},prepareSubmit:function(){self.removeSessionCookie("inboundPreselectedFlightNumber_");self.removeSessionCookie("inboundPreselectedFareFamily_");self.removeSessionCookie("outboundPreselectedFlightNumber_");self.removeSessionCookie("outboundPreselectedFareFamily_");self.removeSessionCookie("clickedOutboundTab_");self.removeSessionCookie("clickedInboundTab_");self.setSessionCookie("inboundPreselectedFlightNumber_"+clientSideData.jSessionId,theUtils.getPreselectedFlightNumber("inbound"),true);self.setSessionCookie("inboundPreselectedFareFamily_"+clientSideData.jSessionId,theUtils.getPreselectedFf("inbound"),true);self.setSessionCookie("outboundPreselectedFlightNumber_"+clientSideData.jSessionId,theUtils.getPreselectedFlightNumber("outbound"),true);self.setSessionCookie("outboundPreselectedFareFamily_"+clientSideData.jSessionId,theUtils.getPreselectedFf("outbound"));var outboundTabs=$(".calendarPricesSection.outbound ul");if($(".calendarPricesSection.outbound ul.selected")){self.setSessionCookie("clickedOutboundTab_"+clientSideData.jSessionId,$(".calendarPricesSection.outbound ul.selected").data("date"));}var inboundTabs=$(".calendarPricesSection.inbound ul");if($(".calendarPricesSection.inbound ul.selected")){self.setSessionCookie("clickedInboundTab_"+clientSideData.jSessionId,$(".calendarPricesSection.inbound ul.selected").data("date"));}var feeWaived=false;$(".selectedFF").each(function(i){var bound;if(i==0){bound="outbound";}else{bound="inbound";}var val=$(this).data("cell-fare-family")+"_"+$(this).data("cell-flight-id");var name=bound+"Preselected";$("<input type='hidden' name='"+name+"' value='"+val+"' />").appendTo(self.ALPI_FORM);$("<input type='hidden' name='FROM_UPSL' value='TRUE' />").appendTo(self.ALPI_FORM);feeWaived=$(this).data("cell-fee-waived");});$("<input type='hidden' name='FEE_WAIVED' value='"+feeWaived+"' />").appendTo(self.ALPI_FORM);$.blockUI({ignoreIfBlocked:true});}});this.FARE_FORM=$("#FARE_FORM");this.CONFIRMATION_FORM=$("#CONFIRMATION_FORM");this.init();this.listen();this.displayPopinsOnEmptyData();if(clientSideData["WDS_OPEN_CALD"]==true){$("#seeAllPricesAndDates").click();}this.initPreselectedFlights();this.displayPriceDiscrepancy();this.initBoundCollapse();this.initSorting();}CoUpslPage.prototype.flightDetailsObs={};CoUpslPage.prototype.removeSessionCookie=function(name){var c=document.cookie.split(";");var returnValue=undefined;$.each(c,function(index){if(typeof(c[index])==="string"&&$.trim(this.split("=")[0]).indexOf(name)==0){document.cookie=$.trim(this.split("=")[0])+"=; expires=Thu, 01 Jan 1970 00:00:01 GMT;";}});};CoUpslPage.prototype.setSessionCookie=function(name,value){if($.browser.msie){document.cookie=name+"="+value+";";}else{document.cookie=name+"="+value+";expires=0";}};CoUpslPage.prototype.getSessionCookie=function(name){var c=document.cookie.split(";");var returnValue=undefined;$.each(c,function(index){if(typeof(c[index])==="string"&&$.trim(this.split("=")[0])==name){returnValue=this.split("=")[1];}});return returnValue;};CoUpslPage.prototype.handlePreselctedTabs=function(){var outboundClicked=this.getSessionCookie("clickedOutboundTab_"+clientSideData.jSessionId);var inboundClicked=this.getSessionCookie("clickedInboundTab_"+clientSideData.jSessionId);var outboundTabSelected=$(".calendarPricesSection.outbound ul.selected");if(outboundTabSelected.data("date")!=outboundClicked){$(".calendarPricesSection.outbound ul[data-date='"+outboundClicked+"']").trigger("click",false);}var inboundTabSelected=$(".calendarPricesSection.inbound ul.selected");if(inboundTabSelected.data("date")!=inboundClicked){$(".calendarPricesSection.inbound ul[data-date='"+inboundClicked+"']").trigger("click",false);}var self=this;window.setTimeout(function(){self.initPreselectedFlights();},0);};CoUpslPage.prototype.showNtpPopin=function(data){var x=[];var messagesNTP={"pd":clientMessages["ALLP.text.atc.tax.pd"],"x":clientMessages["ALLP.text.atc.tax.x"],"rfd":clientMessages["ALLP.text.atc.tax.rfd"]};x[x.length]={"data":data,"messages":messagesNTP};popin=$(tamUtils.getElementForTmpls(template_ntp.tmpl(x)));popin.dialog({autoOpen:true,draggable:false,width:800,modal:true,resizable:false,dialogClass:"ntp"});};CoUpslPage.prototype.manageMiniSearchPanel=function(){$($("#searchPanel").prev()).on("click",function(){$("#search_to").blur();$("#search_from").blur();});};CoUpslPage.prototype.isPincodeDialogNeeded=function(){if(!clientSideData.IS_REDEMPTION){return false;}return clientSideData.ALLOW_PINCODE&&clientSideData.WDS_SMS_CONFIRMED!==true;};CoUpslPage.prototype.isSmsServiceNeeded=function(){if(!clientSideData.IS_REDEMPTION){return false;}return clientSideData.WDS_AWARD_SMS_SERVICE_ENABLED=="true"&&!clientSideData.WDS_FORCE_PIN_CODE&&clientSideData.WDS_SMS_CONFIRMED!==true;};CoUpslPage.prototype.isFFFlyingConditionPositive=function(){var isFFFlyingNegative=clientSideData.IS_FF_FLYING=="FALSE"||$("input[name='IS_FF_FLYING']",$("#ffFlyingQuestionForm")).val()!="TRUE"||!clientSideData.WDS_IS_ONLY_ONE_ADT_FLYING;var paramVal=clientSideData.WDS_DISABLE_AWARD_SMS_ONLY_FF_TRAVELLING;return paramVal||(!paramVal&&isFFFlyingNegative);};CoUpslPage.prototype.handlePincodeDialog=function(){if(clientSideData.PROFILE==null||!clientSideData.PROFILE.frequentFlyer){window.theRdUpslPage.showNotLoggedWarning();}else{if(typeof _gaq!=="undefined"){_gaq.push(["tracker0._trackEvent","SMS Redemption","PIN code popin","PIN code popin displayed instead of SMS redemption popin"]);}window.theRdUpslPage.showPincodeDialog();}};CoUpslPage.prototype.handleSmsService=function(fareForm){var self=this;if(clientSideData.PROFILE==null||!clientSideData.PROFILE.frequentFlyer){window.theRdUpslPage.showNotLoggedWarning();}else{var isPhoneValidationPassed=self.validateProfileMPLUPhone(fareForm);if(isPhoneValidationPassed){window.theRdUpslPage.showSmsServiceDialog();}}};CoUpslPage.prototype.validateProfileMPLUPhone=function(fareForm){var profileMPLUPhoneCount=0;for(var row in clientSideData.PROFILE.phoneList){var profilePhoneType=clientSideData.PROFILE.phoneList[row].phoneType;if(profilePhoneType=="TELMPLU"||profilePhoneType=="MOBMPLU"){profileMPLUPhoneCount++;}}if(profileMPLUPhoneCount==0){fareForm.wdkform("option","errorPanel").errorPanel("addError",null,null,clientMessages["ALLP.error.LateLogin.PleaseAddPhoneNumbersToProfile"]);$("#pageError").scrollTo();return false;}return true;};CoUpslPage.prototype.handleLimitsOnDateTabs=function(){if($("section.calendarPricesSection ul.selected").length>1&&clientSideData.IS_ROUND_TRIP==true){$("section.calendarPricesSection ul.selected").each(function(){var currDate=jQuery.trim($(this).find("li span").text());if($(this).parent().hasClass("outbound")&&$("section.inbound").length){$("section.inbound span.inboundDate").each(function(){if(jQuery.trim($(this).text())<currDate){$(this).parent().parent().removeClass("unselect").addClass("disabled");}else{if(!$(this).parent().parent().hasClass("fromStart")){var cell=$(this).parent().parent().removeClass("disabled");if(!cell.hasClass("selected")){cell.addClass("unselect");}}}});}else{$("section.outbound span.outboundDate").each(function(){if(jQuery.trim($(this).text())>currDate){$(this).parent().parent().removeClass("unselect").addClass("disabled");}else{if(!$(this).parent().parent().hasClass("fromStart")){var cell=$(this).parent().parent().removeClass("disabled");if(!cell.hasClass("selected")){cell.addClass("unselect");}}}});}});}};CoUpslPage.prototype.init=function(){var self=this;this.manageMiniSearchPanel();self.handleLimitsOnDateTabs();var isEligibleForNoRefundRebook=(typeof clientSideData.IS_PAID_ASYNC!=="undefined"&&clientSideData.IS_PAID_ASYNC)||clientSideData.ELIGIBLE_FOR_NO_REFUND_REBOOKING;if(clientSideData.PAGE_CODE=="ATC_UPSL"&&isEligibleForNoRefundRebook){$(".calendarPricesSection, #seeAllPricesAndDates").hide();}fareForm=wdk.form("FARE_FORM",{ajaxSubmit:true,ajaxOptions:{dataType:"json",success:function(data){var warningOnly=true;var warningExists=false;if(data.mapDataOut){for(var i in data["mapDataOut"].LIST_MSG){if(typeof data["mapDataOut"].LIST_MSG[i]!="function"){if(data["mapDataOut"].LIST_MSG[i].TYPE!="W"){warningOnly=false;}else{warningExists=true;}}}if(warningOnly&&data["mapDataOut"].TX_STATUS!="FAIL"){self.ALPI_FORM.append(theUtils.createPageTicketInput(data.mapDataOut.PAGE_TICKET));if(warningExists){for(var i in data["mapDataOut"].LIST_MSG){if(typeof data["mapDataOut"].LIST_MSG[i]!="function"){fareForm.wdkform("option","pageWarning").errorPanel("addError",null,null,data["mapDataOut"].LIST_MSG[i].TEXT);}}$("#pageError").scrollTo();}if(self.isSmsServiceNeeded()&&self.isFFFlyingConditionPositive()){$("#smsService input[name='PAGE_TICKET']").val(data["mapDataOut"]["PAGE_TICKET"]);self.handleSmsService(fareForm);}else{if(self.isPincodeDialogNeeded()&&self.isFFFlyingConditionPositive()){self.handlePincodeDialog();}else{if(typeof data.mapDataUI!="undefined"&&data.mapDataUI.DISPLAY_UPGRADE_TEASER){$("#bundleUpgradeContentContainer").html(data.mapDataUI.BUNDLE_UPGRADE_CONTENT[0]);window.bundleUpgradePopin.openDialog({"showNTP":clientSideData.PAGE_CODE==="ATC_UPSL"&&CoUpslPage.prototype.totalToBePaid<=0,"data":data});return;}if(clientSideData.PAGE_CODE=="ATC_UPSL"){if(CoUpslPage.prototype.totalToBePaid>0){window.setTimeout(function(){self.ALPI_FORM.submit();},1);}else{self.showNtpPopin(data);}}else{window.setTimeout(function(){self.ALPI_FORM.submit();},1);}}}}else{if(data["mapDataOut"].LIST_MSG!=null){for(var i in data["mapDataOut"].LIST_MSG){if(typeof data["mapDataOut"].LIST_MSG[i]!="function"){if(data["mapDataOut"].LIST_MSG[i].TYPE=="W"){fareForm.wdkform("option","pageWarning").errorPanel("addError",null,null,data["mapDataOut"].LIST_MSG[i].TEXT);}else{if(data["mapDataOut"].LIST_MSG[i].TYPE=="E"){fareForm.wdkform("option","errorPanel").errorPanel("addError",null,null,data["mapDataOut"].LIST_MSG[i].TEXT);}}}}$("#pageError").scrollTo();}}}else{if(data.mapDataUI&&data.mapDataUI.LIST_MSG!=null){for(var i in data["mapDataUI"].LIST_MSG){if(typeof data["mapDataUI"].LIST_MSG[i]!="function"){if(data["mapDataUI"].LIST_MSG[i].TYPE=="W"){fareForm.wdkform("option","pageWarning").errorPanel("addError",null,null,data["mapDataUI"].LIST_MSG[i].TEXT);}else{if(data["mapDataUI"].LIST_MSG[i].TYPE=="E"){fareForm.wdkform("option","errorPanel").errorPanel("addError",null,null,data["mapDataUI"].LIST_MSG[i].TEXT);}}}}$("#pageError").scrollTo();}}},error:function(){$.unblockUI();fareForm.wdkform("option","errorPanel").errorPanel("addError",null,null,clientMessages[clientSideData.PAGE_CODE+".error.ErrorFareLoad"]);}},errorPanel:$("#pageError")});var boundNotChanged=clientSideData.ATC_BOUND_NOT_CHANGED;if(typeof boundNotChanged!=="undefined"){self.rightPanel.boundId=boundNotChanged.BOUND_ID;var boundRP=[];for(var i=0;i<boundNotChanged.SEGMENTS.length;i++){boundRP[boundRP.length]={"flightNumber":boundNotChanged.SEGMENTS[i].FLIGHT_NUMBER,"operatedBy":boundNotChanged.SEGMENTS[i].FLIGHT_NUMBER,"date":boundNotChanged.SEGMENTS[i].B_DATE,"from":{"cityCode":boundNotChanged.SEGMENTS[i].B_LOCATION.CITY_CODE,"airportCode":boundNotChanged.SEGMENTS[i].B_LOCATION.LOCATION_CODE,"date":boundNotChanged.SEGMENTS[i].B_DATE,"time":boundNotChanged.SEGMENTS[i].FLIGHT_TIME},"to":{"cityCode":boundNotChanged.SEGMENTS[i].E_LOCATION.CITY_CODE,"airportCode":boundNotChanged.SEGMENTS[i].E_LOCATION.CITY_CODE,"date":boundNotChanged.SEGMENTS[i].E_DATE,"time":boundNotChanged.SEGMENTS[i].FLIGHT_TIME},"duration":boundNotChanged.SEGMENTS[i].DURATION,"aircraft":boundNotChanged.SEGMENTS[i].EQUIPMENT.NAME,"cabin":boundNotChanged.SEGMENTS[i].CABIN,"baggageAllowance":""};}if(typeof boundNotChanged.TOTAL_DURATION!="undefined"){self.rightPanel.totalDuration=boundNotChanged.TOTAL_DURATION;}self.rightPanel.segments=boundRP;if(typeof boundNotChanged.FARE_FAMILY!=="undefined"){self.rightPanel.ff=$("input[name='BOUND_NOT_CHANGED_FF_NAME']").val();}self.rightPanel.ffCode=jQuery.trim(boundNotChanged.FARE_FAMILY);$(document).trigger("updateBound",self.rightPanel);}CoUpslPage.prototype.totalToBePaid=0;};CoUpslPage.prototype.sortFlightDetailsStart=function(table){table.data("flightDetailsOnlyLastVisible",(table.find("tr.details:not(.last)").filter(":visible").length>0)?false:true);table.find("tr.details").addClass("none");};CoUpslPage.prototype.sortFlightDetailsStop=function(table){var selectedFareFamily=$(".selectedFF",table);if(selectedFareFamily.css("display")!="none"){if(typeof table.data("flightDetailsOnlyLastVisible")==="undefined"){this.sortFlightDetailsStart(table);}table.find("tr.details").addClass("none");table.find(".selectedFF").trigger("click");if(table.data("flightDetailsOnlyLastVisible")){table.find("tr.details.last .caption3").trigger("click");}}else{table.find("tr.details").addClass("none");}};CoUpslPage.prototype.handleBlankRowDisplay=function(table){table.find("tbody tr.blankRow").remove();table.find("tbody tr").each(function(){var nextTableFlightRow=$(this).next();while(typeof nextTableFlightRow!="undefined"&&nextTableFlightRow.is("tr")&&(nextTableFlightRow.hasClass("flightNextSegment")||nextTableFlightRow.hasClass("details")||(nextTableFlightRow.css("display")=="none"))){return;}var blankTds="";for(var i=0;i<4+clientSideData.LIST_FF.length;i++){blankTds=blankTds+"<td></td>";}$(this).after('<tr class="blankRow tbl-spacer">'+blankTds+"</tr>");});};CoUpslPage.prototype.flightTableDataExtractionFunc=function(node){var cell=$(node);var tr=cell.parent("tr");if(tr.hasClass("details")||tr.hasClass("flightNextSegment")||tr.hasClass("stopDuration")||tr.hasClass("totalDurationRow")){return undefined;}if(cell.hasClass("fromTh")&&!tr.hasClass("totalDurationRow")){return cell.data("cellValue");}if(cell.hasClass("toTh")&&!tr.hasClass("totalDurationRow")){if(tr.hasClass("flightType-Direct")){return cell.data("cellValue");}else{var toConnection=tr.nextUntil(".totalDurationRow").last();return toConnection.find(".toTh").data("cellValue");}}if(cell.hasClass("durationTh")){return cell.data("cellValue");}if($(node).hasClass("ff")){if($(node).hasClass("disabled")){return Infinity;}return $(node).data("cellValue");}if(cell.hasClass("rjsTh")&&!tr.hasClass("totalDurationRow")){return cell.data("cellValue");}};CoUpslPage.prototype.initSorting=function(){var self=this;var headersOpt={1:{sorter:"digit"},2:{sorter:"digit"},3:{sorter:0},4:{sorter:"digit"}};var i=0;for(i=0;i<$("table.bound:first th.family").length;i++){headersOpt[i+5]={sorter:"digit"};}headersOpt[i+5]={sorter:"digit"};$("table.realTable.bound").tablesorter({textExtraction:self.flightTableDataExtractionFunc,selectorHeaders:"thead th",cssChildRow:"flightNextSegment",headers:headersOpt,cssDesc:"down",cssAsc:"up",cssHeader:"right"}).bind("sortStart",function(){var noneSection=$("#noBoundTemplate");var table=$(this);if(!table.find("tbody").hasClass("none")&&(table.parent().find(".noBoundTemplateClass").size()==0)){table.after(noneSection.clone().find("div").addClass("noBoundTemplateClass").parent().removeClass("none").html());}table.addClass("none").find(".details").remove();table.find("tbody tr.blankRow").remove();self.sortFlightDetailsStart(table);}).bind("sortEnd",function(){var table=$(this);self.sortFlightDetailsStop(table);self.handleBlankRowDisplay(table);setTimeout((function(table){return function(){table.removeClass("none");$(".noBoundTemplateClass").remove();};})($(this)),1000);});$("table.outbound.realTable:first, table.inbound.realTable:first").each(function(){var table=$(this);var selector;if(table.hasClass("outbound")){selector="outbound";}else{selector="inbound";}table.find("thead th.fromTh").on("click",function(){var sorting;if($(this).hasClass("up")){sorting=[[0,1]];}else{sorting=[[0,0]];}$(this).trigger("sorton",[sorting]);return false;});table.find("thead th.toTh").on("click",function(){var sorting;if($(this).hasClass("up")){sorting=[[1,1]];}else{sorting=[[1,0]];}$(this).trigger("sorton",[sorting]);return false;});table.find("thead th.durationTh").on("click",function(){var sorting;if($(this).hasClass("up")){sorting=[[3,1]];}else{sorting=[[3,0]];}$(this).trigger("sorton",[sorting]);return false;});table.find("thead th.family").on("click",function(){var x=$(this).data("ffIndex")+4;var sorting;if($(this).hasClass("up")){sorting=[[x,1]];}else{sorting=[[x,0]];}$(this).trigger("sorton",[sorting]);});});$(".unSortable").unbind();};CoUpslPage.prototype.initBoundCollapse=function(){$("table.bound[id!=inbound_list_flight_direct][id!=outbound_list_flight_direct] .selectedFF").each(function(){$(this).closest("table.bound").prev().trigger("click");});};CoUpslPage.prototype.displayPopinsOnEmptyData=function(){var self=this;var lackOfData=false;if($("table.outbound").length==0&&$("div.outboundNotModificable").length==0){lackOfData=true;}if(clientSideData.IS_ROUND_TRIP&&($("table.inbound").length==0&&$("div.inboundNotModificable").length==0)){lackOfData=true;}if(lackOfData){$("#flightSummaryInterstice").show();$("#flightSummaryArticle").hide();$(".calendarPricesSection *").hide();$(".calendarPricesSection ").append($("#noBoundTemplate").clone().find("div").addClass("noBoundTemplateClass").css("margin","0"));this.removeBoundsAndShowLoading();if(clientSideData.IS_REDEMPTION){clientSideData["NO_AVAILS_SHOW_CALD"]=true;}else{$("#seeAllPricesAndDates").trigger("click");$(".ui-dialog").find(".ui-dialog-titlebar-close").hide();var warning=$("#popinWarning").errorPanel();warning.errorPanel("addError",null,null,clientMessages[clientSideData.MSG_PAGE_CODE+".text.NoAvailForceCalendar"]);}}if(clientSideData.IS_ROUND_TRIP){$("section.calendarPricesSection ul.selected").each(function(){self.updateLowestPricePanelForOWD($(this));});}};CoUpslPage.prototype.removeBoundsAndShowLoading=function(){var noneSection=$("#noBoundTemplate");$("#sticky-wrap-out").remove();var obInsertAfter=this.getOutBoundElementToInsertPriceTables();obInsertAfter.after(noneSection.clone().find("div").addClass("noBoundTemplateClass").parent().removeClass("none").html());$("#0_filter-form-reset-remote").remove();var stickyWrapper=$("#sticky-wrap-in");if(stickyWrapper.length>0){$("#sticky-wrap-in").remove();var ibInsertAfter=this.getInBoundElementToInsertPriceTables();ibInsertAfter.after(noneSection.clone().find("div").addClass("noBoundTemplateClass").parent().removeClass("none").html());}$("#1_filter-form-reset-remote").remove();};CoUpslPage.prototype.updatePricesFotOppositeBound=function(self,bound){var matrix=clientSideData.OD_UPSL_MATRIX;var getBound=function(aBound){var bound=$("."+aBound+" td.ff.selectedFF").attr("class").match(ffPattern)[1]+"_"+$("."+aBound+" td.ff.selectedFF").parent().attr("class").match(flightPattern)[1];return bound;};var lowestImg='<small class="fr"><small class="ico cheap"></small></small>';var flightPattern=/flightId-(\d+)/;var ffPattern=/ff-(\w+)/;var id=self.attr("class").match(flightPattern)[1];if(typeof id==="undefined"){return;}var outbound;var inbound;if($(".outbound td.ff.selectedFF").length>0){outbound=getBound("outbound");}else{outbound=matrix.THE_LOWEST_OUTBOUND;if(clientSideData.IS_PAID_ASYNC||clientSideData.ELIGIBLE_FOR_NO_REFUND_REBOOKING){outbound=matrix.THE_LOWEST_OUTBOUND_NO_REFUND;}}if($(".inbound td.ff.selectedFF").length>0){inbound=getBound("inbound");}else{inbound=matrix.THE_LOWEST_INBOUND;if(clientSideData.IS_PAID_ASYNC||clientSideData.ELIGIBLE_FOR_NO_REFUND_REBOOKING){inbound=matrix.THE_LOWEST_INBOUND_NO_REFUND;}}self.find("td.ff").each(function(){var ff=$(this).attr("class").match(ffPattern)[1];var innerCondtion=false;var value;var uncombinable=false;var isEligibleForNoRefundRebook=(typeof clientSideData.IS_PAID_ASYNC!=="undefined"&&clientSideData.IS_PAID_ASYNC)||clientSideData.ELIGIBLE_FOR_NO_REFUND_REBOOKING;if(bound=="inbound"||bound=="inbound-uncombinable"){if(typeof matrix[outbound][ff+"_"+id]!=="undefined"&&!isEligibleForNoRefundRebook){innerCondtion=matrix[outbound][ff+"_"+id].LOWEST_INBOUND;$(this).removeClass("disabled");$(this).removeClass("uncombinable");if(clientSideData.PAGE_CODE!="ATC_UPSL"){value=matrix[outbound][ff+"_"+id].LIST_TRAVELLER_TYPE[0].LIST_TRAVELLER_PRICE[0].LIST_BOUND_PRICE[1][clientSideData.PRICE_TYPE];}else{value=matrix[outbound][ff+"_"+id].LIST_PNR_PRICE[0].LIST_BOUND_PRICE[1].TOTAL_COLLECT_BALANCE.AMOUNT-matrix[outbound][ff+"_"+id].LIST_PNR_PRICE[0].LIST_BOUND_PRICE[1].REFUND_BALANCE.AMOUNT;}}else{if(clientSideData.PAGE_CODE==="ATC_UPSL"&&typeof matrix[outbound][ff+"_"+id]!=="undefined"&&isEligibleForNoRefundRebook&&matrix[outbound][ff+"_"+id].IS_REBOOK_POSSIBLE){innerCondtion=matrix[outbound][ff+"_"+id].LOWEST_INBOUND;$(this).removeClass("disabled");$(this).removeClass("uncombinable");value=matrix[outbound][ff+"_"+id].LIST_PNR_PRICE[0].LIST_BOUND_PRICE[1].TOTAL_COLLECT_BALANCE.AMOUNT-matrix[outbound][ff+"_"+id].LIST_PNR_PRICE[0].LIST_BOUND_PRICE[1].REFUND_BALANCE.AMOUNT;}else{var found=false;for(key in matrix){if(typeof matrix[key]!="function"&&typeof matrix[key][ff+"_"+id]!=="undefined"&&(clientSideData.PAGE_CODE!="ATC_UPSL"||isEligibleForNoRefundRebook||matrix[key][ff+"_"+id].IS_REBOOK_POSSIBLE)){found=true;$(this).removeClass("disabled");$(this).addClass("uncombinable");uncombinable=true;if(clientSideData.PAGE_CODE!="ATC_UPSL"){value=matrix[key][ff+"_"+id].LIST_TRAVELLER_TYPE[0].LIST_TRAVELLER_PRICE[0].LIST_BOUND_PRICE[1][clientSideData.PRICE_TYPE];}else{value=matrix[key][ff+"_"+id].LIST_PNR_PRICE[0].LIST_BOUND_PRICE[1].TOTAL_COLLECT_BALANCE.AMOUNT-matrix[key][ff+"_"+id].LIST_PNR_PRICE[0].LIST_BOUND_PRICE[1].REFUND_BALANCE.AMOUNT;}}}if(!found){$(this).addClass("disabled");}}}}else{if(bound=="outbound"||bound=="outbound-uncombinable"){if(typeof matrix[ff+"_"+id]!=="undefined"&&typeof matrix[ff+"_"+id][inbound]!=="undefined"&&!isEligibleForNoRefundRebook){if(clientSideData.PAGE_CODE!="ATC_UPSL"){value=matrix[ff+"_"+id][inbound].LIST_TRAVELLER_TYPE[0].LIST_TRAVELLER_PRICE[0].LIST_BOUND_PRICE[0][clientSideData.PRICE_TYPE];}else{value=matrix[ff+"_"+id][inbound].LIST_PNR_PRICE[0].LIST_BOUND_PRICE[0].TOTAL_COLLECT_BALANCE.AMOUNT-matrix[ff+"_"+id][inbound].LIST_PNR_PRICE[0].LIST_BOUND_PRICE[0].REFUND_BALANCE.AMOUNT;}$(this).removeClass("disabled");$(this).removeClass("uncombinable");innerCondtion=matrix[ff+"_"+id][inbound].LOWEST_OUTBOUND;}else{if(clientSideData.PAGE_CODE==="ATC_UPSL"&&typeof matrix[ff+"_"+id]!=="undefined"&&typeof matrix[ff+"_"+id][inbound]!=="undefined"&&isEligibleForNoRefundRebook&&matrix[ff+"_"+id][inbound].IS_REBOOK_POSSIBLE){$(this).removeClass("disabled");$(this).removeClass("uncombinable");innerCondtion=matrix[ff+"_"+id][inbound].LOWEST_OUTBOUND;value=matrix[ff+"_"+id][inbound].LIST_PNR_PRICE[0].LIST_BOUND_PRICE[0].TOTAL_COLLECT_BALANCE.AMOUNT-matrix[ff+"_"+id][inbound].LIST_PNR_PRICE[0].LIST_BOUND_PRICE[0].REFUND_BALANCE.AMOUNT;}else{if(typeof matrix[ff+"_"+id]!=="undefined"){$(this).removeClass("disabled");$(this).addClass("uncombinable");for(key in matrix[ff+"_"+id]){if(typeof matrix[ff+"_"+id][key]!="function"){if(clientSideData.PAGE_CODE!="ATC_UPSL"){value=matrix[ff+"_"+id][key].LIST_TRAVELLER_TYPE[0].LIST_TRAVELLER_PRICE[0].LIST_BOUND_PRICE[0][clientSideData.PRICE_TYPE];}else{value=matrix[ff+"_"+id][key].LIST_PNR_PRICE[0].LIST_BOUND_PRICE[0].TOTAL_COLLECT_BALANCE.AMOUNT-matrix[ff+"_"+id][key].LIST_PNR_PRICE[0].LIST_BOUND_PRICE[0].REFUND_BALANCE.AMOUNT;}break;}}uncombinable=true;}else{$(this).addClass("disabled");}}}}}if(!$(this).hasClass("disabled")){$(this).data("cellValue",value);value=theUtils.formatPrice(value);if(innerCondtion){value=lowestImg+"<strong>"+value+"</strong>";$(this).addClass("lowest em3");}else{$(this).removeClass("lowest em3");}if(uncombinable){value='<small class="ico uncomb"></small>'+value;}if(typeof $(this).data("cellLastseats")!=="undefined"){value+='<br /><small class="ico seat em">'+$(this).data("cellLastseats")+"</small>";}$(this).html("<div class='cell-inside'>"+value+"</div>");}});if(bound=="inbound-uncombinable"||bound=="outbound-uncombinable"){var aBound;if(bound=="inbound-uncombinable"){aBound="inbound";}else{if(bound=="outbound-uncombinable"){aBound="outbound";}}$("."+aBound+" .selectedFF").removeClass("f1");$("."+aBound+" .selectedFF").removeClass("selectedFF");$("."+aBound+" .details").remove();$("."+aBound+" .details").remove();$("."+aBound+" td[class*='family']").removeClass(function(){var classes=$(this).attr("class").split(/\s/);for(aClass in classes){if(typeof classes[aClass]!="function"&&-1<aClass){var res=classes[aClass].match(/family\d+/);if(res!=null){return res[0];}}}return null;});}};CoUpslPage.prototype.displayPriceDiscrepancy=function(){if(clientSideData.MSG_PAGE_CODE=="CO_UPSL"||clientSideData.PAGE_CODE=="ATC_UPSL"){var outboundCal=$(".calendarPricesSection.outbound .selected li.tc strong").data("cell-value");var inboundCal=$(".calendarPricesSection.inbound .selected li.tc strong").data("cell-value");var outboundUpsl=$($("table.outbound .lowest")[0]).data("cell-value");var inboundUpsl=$($("table.inbound .lowest")[0]).data("cell-value");if(outboundCal!=outboundUpsl||inboundCal!=inboundUpsl){var warning=$("#pageWarning").errorPanel();warning.errorPanel("addError",null,null,clientMessages[clientSideData.MSG_PAGE_CODE+".text.PriceDiscrepencyDetected"]);}}};CoUpslPage.prototype.initPreselectedFlights=function(manualTrigger){var outbound,inbound;var self=this;if(clientSideData.IS_OWD){if(typeof clientSideData.OD_UPSL_MATRIX==="undefined"){return;}var matrix=clientSideData.OD_UPSL_MATRIX;if(clientSideData.IS_PAID_ASYNC||clientSideData.ELIGIBLE_FOR_NO_REFUND_REBOOKING){outbound=matrix.THE_LOWEST_OUTBOUND_NO_REFUND;inbound=matrix.THE_LOWEST_INBOUND_NO_REFUND;}else{outbound=matrix.THE_LOWEST_OUTBOUND;inbound=matrix.THE_LOWEST_INBOUND;}if(manualTrigger==false||($(".calendarPricesSection.outbound .selected").data("date")==self.getSessionCookie("clickedOutboundTab_"+clientSideData.jSessionId))){if(clientSideData.outboundPreselectedFlightNumber==null){clientSideData.outboundPreselectedFlightNumber=self.getSessionCookie("outboundPreselectedFlightNumber_"+clientSideData.jSessionId);}if(clientSideData.outboundPreselectedFf==null){clientSideData.outboundPreselectedFf=self.getSessionCookie("outboundPreselectedFareFamily_"+clientSideData.jSessionId);}}if(manualTrigger==false||($(".calendarPricesSection.inbound .selected").data("date")==self.getSessionCookie("clickedInboundTab_"+clientSideData.jSessionId))){if(clientSideData.inboundPreselectedFlightNumber==null){clientSideData.inboundPreselectedFlightNumber=self.getSessionCookie("inboundPreselectedFlightNumber_"+clientSideData.jSessionId);}if(clientSideData.inboundPreselectedFf==null){clientSideData.inboundPreselectedFf=self.getSessionCookie("inboundPreselectedFareFamily_"+clientSideData.jSessionId);}}if(typeof clientSideData["outboundPreselected"]!=="undefined"&&typeof clientSideData["inboundPreselected"]!=="undefined"){if(typeof matrix[clientSideData["outboundPreselected"]]!="undefined"&&typeof matrix[clientSideData["outboundPreselected"]][clientSideData["inboundPreselected"]]!=="undefined"||manualTrigger==false){outbound=clientSideData["outboundPreselected"];inbound=clientSideData["inboundPreselected"];}}if(clientSideData.outboundPreselectedFlightNumber!=null&&clientSideData.outboundPreselectedFlightNumber!=undefined&&clientSideData.outboundPreselectedFf!=null&&clientSideData.outboundPreselectedFf!=undefined){$(".outbound tr[data-flightnumber='"+clientSideData.outboundPreselectedFlightNumber+"']").find("td[data-cell-fare-family='"+clientSideData.outboundPreselectedFf+"']").click();alreadySelected=true;}else{$($(".outbound .flight .lowest:not(.disabled)")[0]).trigger("click");}if(clientSideData.inboundPreselectedFlightNumber!=null&&clientSideData.inboundPreselectedFlightNumber!=undefined&&clientSideData.inboundPreselectedFf!=null&&clientSideData.inboundPreselectedFf!=undefined){$(".inbound tr[data-flightnumber='"+clientSideData.inboundPreselectedFlightNumber+"']").find("td[data-cell-fare-family='"+clientSideData.inboundPreselectedFf+"']").click();alreadySelected=true;}else{$($(".inbound .flight .lowest")[0]).trigger("click");}$(".inbound .flight").each(function(){self.updatePricesFotOppositeBound($(this),"inbound");});$(".outbound .flight").each(function(){self.updatePricesFotOppositeBound($(this),"outbound");});}var triggerClick=function(boundId,bound,manualTrigger){if(typeof boundId!=="undefined"){if(manualTrigger==false||($(".calendarPricesSection.outbound .selected").index()-1==self.getSessionCookie("clickedOutboundTab_"+clientSideData.jSessionId)||$(".calendarPricesSection.inbound .selected").data("date")==self.getSessionCookie("clickedInboundTab_"+clientSideData.jSessionId))){if(clientSideData.outboundPreselectedFlightNumber==null){clientSideData.outboundPreselectedFlightNumber=self.getSessionCookie("outboundPreselectedFlightNumber_"+clientSideData.jSessionId);}if(clientSideData.outboundPreselectedFf==null){clientSideData.outboundPreselectedFf=self.getSessionCookie("outboundPreselectedFareFamily_"+clientSideData.jSessionId);}if(clientSideData.inboundPreselectedFlightNumber==null){clientSideData.inboundPreselectedFlightNumber=self.getSessionCookie("inboundPreselectedFlightNumber_"+clientSideData.jSessionId);}if(clientSideData.inboundPreselectedFf==null){clientSideData.inboundPreselectedFf=self.getSessionCookie("inboundPreselectedFareFamily_"+clientSideData.jSessionId);}if(clientSideData.outboundPreselectedFlightNumber==null){clientSideData.outboundPreselectedFlightNumber=self.getSessionCookie("outboundPreselectedFlightNumber_"+clientSideData.jSessionId);}if(clientSideData.outboundPreselectedFf==null){clientSideData.outboundPreselectedFf=self.getSessionCookie("outboundPreselectedFareFamily_"+clientSideData.jSessionId);}if(clientSideData.inboundPreselectedFlightNumber==null){clientSideData.inboundPreselectedFlightNumber=self.getSessionCookie("inboundPreselectedFlightNumber_"+clientSideData.jSessionId);}if(clientSideData.inboundPreselectedFf==null){clientSideData.inboundPreselectedFf=self.getSessionCookie("inboundPreselectedFareFamily_"+clientSideData.jSessionId);}var alreadySelected=false;if(clientSideData.outboundPreselectedFlightNumber!=null&&clientSideData.outboundPreselectedFlightNumber!=undefined&&clientSideData.outboundPreselectedFf!=null&&clientSideData.outboundPreselectedFf!=undefined){$(".outbound tr[data-flightnumber='"+clientSideData.outboundPreselectedFlightNumber+"']").find("td[data-cell-fare-family='"+clientSideData.outboundPreselectedFf+"']").click();alreadySelected=true;}else{$($(".outbound .flight .lowest")[0]).trigger("click");}if(clientSideData.inboundPreselectedFlightNumber!=null&&clientSideData.inboundPreselectedFlightNumber!=undefined&&clientSideData.inboundPreselectedFf!=null&&clientSideData.inboundPreselectedFf!=undefined){$(".inbound tr[data-flightnumber='"+clientSideData.inboundPreselectedFlightNumber+"']").find("td[data-cell-fare-family='"+clientSideData.inboundPreselectedFf+"']").click();alreadySelected=true;}else{$($(".inbound .flight .lowest")[0]).trigger("click");}}else{var res=boundId.split(/_/);$("."+bound+" .flightId-"+res[1]+" .ff-"+res[0]).click();}}else{if(manualTrigger==false||($(".calendarPricesSection.outbound .selected").index()-1==self.getSessionCookie("clickedOutboundTab_"+clientSideData.jSessionId)||$(".calendarPricesSection.inbound .selected").data("date")==self.getSessionCookie("clickedInboundTab_"+clientSideData.jSessionId))){if(clientSideData.outboundPreselectedFlightNumber==null){clientSideData.outboundPreselectedFlightNumber=self.getSessionCookie("outboundPreselectedFlightNumber_"+clientSideData.jSessionId);}if(clientSideData.outboundPreselectedFf==null){clientSideData.outboundPreselectedFf=self.getSessionCookie("outboundPreselectedFareFamily_"+clientSideData.jSessionId);}if(clientSideData.inboundPreselectedFlightNumber==null){clientSideData.inboundPreselectedFlightNumber=self.getSessionCookie("inboundPreselectedFlightNumber_"+clientSideData.jSessionId);}if(clientSideData.inboundPreselectedFf==null){clientSideData.inboundPreselectedFf=self.getSessionCookie("inboundPreselectedFareFamily_"+clientSideData.jSessionId);}}if(typeof clientSideData["outboundPreselected"]==="undefined"&&$.jStorage.get("outboundPreselected")!=null){clientSideData["outboundPreselected"]=$.jStorage.get("outboundPreselected");}if(typeof clientSideData["inboundPreselected"]==="undefined"&&$.jStorage.get("inboundPreselected")!=null){clientSideData["inboundPreselected"]=$.jStorage.get("inboundPreselected");}var calendarPrice=$(".calendarPricesSection."+bound+" .selected").data("amountReference");var possibleTrigger=$("table."+bound+" td[data-cell-amountReference='"+calendarPrice+"']");var alreadySelected=false;if(clientSideData.outboundPreselectedFlightNumber!=null&&clientSideData.outboundPreselectedFlightNumber!=undefined&&clientSideData.outboundPreselectedFf!=null&&clientSideData.outboundPreselectedFf!=undefined){$(".outbound tr[data-flightnumber='"+clientSideData.outboundPreselectedFlightNumber+"']").find("td[data-cell-fare-family='"+clientSideData.outboundPreselectedFf+"']").click();alreadySelected=true;}else{$($(".outbound .flight .lowest")[0]).trigger("click");}if(clientSideData.inboundPreselectedFlightNumber!=null&&clientSideData.inboundPreselectedFlightNumber!=undefined&&clientSideData.inboundPreselectedFf!=null&&clientSideData.inboundPreselectedFf!=undefined){$(".inbound tr[data-flightnumber='"+clientSideData.inboundPreselectedFlightNumber+"']").find("td[data-cell-fare-family='"+clientSideData.inboundPreselectedFf+"']").click();alreadySelected=true;}else{$($(".inbound .flight .lowest")[0]).trigger("click");}if(typeof clientSideData[bound+"Preselected"]!=="undefined"&&!alreadySelected){var res=clientSideData[bound+"Preselected"].split(/_/);var chosen=$("."+bound+" .flightId-"+res[1]+" .ff-"+res[0]);if(chosen.length>0&&!chosen.hasClass("disabled")){chosen.trigger("click",manualTrigger);}else{if($("."+bound+" .flight .lowest").length>0){$("."+bound+" .flight .lowest").eq(0).trigger("click",manualTrigger);}else{$("."+bound+" .flight .ff:not(.disabled)").eq(0).trigger("click",manualTrigger);}}}else{if(typeof calendarPrice!=="undefined"&&possibleTrigger.length>0){if(manualTrigger!=false&&!alreadySelected){possibleTrigger.eq(0).trigger("click",manualTrigger);}}else{if(!alreadySelected){if($("."+bound+" .flight .lowest").length>0){$("."+bound+" .flight .lowest").eq(0).trigger("click",manualTrigger);}else{if($("."+bound+" .flight .rightE:not(.disabled)").length>0){$("."+bound+" .flight .rightE:not(.disabled)").eq(0).trigger("click",manualTrigger);}else{$("."+bound+" .flight .ff:not(.disabled)").eq(0).trigger("click",manualTrigger);}}}}}}};$("table.inbound").filter(":not(:first)").find("thead tr").addClass("none");$("table.outbound").filter(":not(:first)").find("thead tr").addClass("none");$("table.inbound:first").find("tbody, thead tr").removeClass("none");$("table.outbound:first").find("tbody, thead tr").removeClass("none");triggerClick(outbound,"outbound",manualTrigger);triggerClick(inbound,"inbound",manualTrigger);if(clientSideData.IS_REDEMPTION){if(clientSideData.outboundPreselectedFlightNumber==null){clientSideData.outboundPreselectedFlightNumber=self.getSessionCookie("outboundRdFn_"+clientSideData.jSessionId);}if(clientSideData.outboundPreselectedFf==null){clientSideData.outboundPreselectedFf=self.getSessionCookie("outboundRdFf_"+clientSideData.jSessionId);}if(clientSideData.outboundPreselected!=null&&clientSideData.outboundPreselected!=undefined&&this.fistTimeInUpsl){var res=clientSideData.outboundPreselected.split(/_/);$(".outbound"+" .flightId-"+res[1]+" .ff-"+res[0]).click();}else{$(".outbound tr[data-flightnumber='"+clientSideData.outboundPreselectedFlightNumber+"']").find("td[data-cell-fare-family='"+clientSideData.outboundPreselectedFf+"']").click();}if(clientSideData.IS_ROUND_TRIP){if(clientSideData.inboundPreselectedFlightNumber==null){clientSideData.inboundPreselectedFlightNumber=self.getSessionCookie("inboundRdFn_"+clientSideData.jSessionId);}if(clientSideData.inboundPreselectedFf==null){clientSideData.inboundPreselectedFf=self.getSessionCookie("inboundRdFf_"+clientSideData.jSessionId);}if(clientSideData.inboundPreselected!=null&&clientSideData.inboundPreselected!=undefined&&this.fistTimeInUpsl){var res=clientSideData.inboundPreselected.split(/_/);$(".inbound"+" .flightId-"+res[1]+" .ff-"+res[0]).click();}else{$(".inbound tr[data-flightnumber='"+clientSideData.inboundPreselectedFlightNumber+"']").find("td[data-cell-fare-family='"+clientSideData.inboundPreselectedFf+"']").click();}}}};CoUpslPage.prototype.clickOnTd=(function(){var clickIterator=0;var getFlightNrOnUpslPage=function(tdElem){var parent=tdElem.parent();var id=parent.attr("class").match(/flightId-\d+/)[0];var response=jQuery.trim(parent.find(".flightNumber a").text());response=response.substr(2,response.length);while(typeof parent.next()!="undefined"&&parent.next().is("tr")&&parent.next().hasClass("flightNextSegment")){parent=parent.next();var flight=jQuery.trim(parent.find(".flightNumber a").text());if(typeof flight!=="undefined"&&flight!=""){response+="_"+flight.substr(2,response.length);}}return response;};var flightDetailsFn=function(self){var _benefitsInfo=clientSideData["benefitsInfo"];var _benefitsValues=clientSideData["benefitsValues"].values;var config=[];for(var key in _benefitsInfo){if(_benefitsInfo.hasOwnProperty(key)){var record={Row:{Internal:{},Data:{}}};if(key==0){_seatMapConfig=clientSideData["seatMapConfig"];_compareFareConfig=clientSideData["compareFareConfig"];_legalNoticeConfig=clientSideData["legalNoticeConfig"];_fDButtons=clientSideData["fDButtons"];record.Row.Data.seatMap=_seatMapConfig;record.Row.Data.compare=_compareFareConfig;record.Row.Data.legalNotice=_legalNoticeConfig;record.Row.Data.buttons=_fDButtons;}record.Row.Data.icon=clientSideData.WDS_WEBAPP_URL+"/tam_56.32_290917/air/skin/tam/"+clientSideData.SKIN+"/img/benefits/"+_benefitsInfo[key].icon;record.Row.Data.service=_benefitsInfo[key].service;record.Row.Data.name=_benefitsInfo[key].name;record.Row.Data.default_val=_benefitsInfo[key].default_val;if(_benefitsInfo[key].name=="Rebooking"){if(clientSideData.FLOW_STATE.IS_ATC&&!clientSideData.FLOW_STATE.IS_REBOOKING_REDEMPTION){record.Row.Data.ff_values=[];var oppositeBoundSelected=null;var newSelection=self.attr("class").match(/ff-(\w+)/)[1]+"_"+self.parent().attr("class").match(/flightId-(\d+)/)[1];var isOneBoundChange=typeof clientSideData.OD_UPSL_MATRIX==="undefined";var selfFromOutbound=null;if(!isOneBoundChange){if($(self).parents("table.bound.outbound").length!=0){oppositeBoundSelected=getInOutForMatrix("inbound");if(typeof oppositeBoundSelected==="undefined"){if(clientSideData.IS_PAID_ASYNC||clientSideData.ELIGIBLE_FOR_NO_REFUND_REBOOKING){oppositeBoundSelected=clientSideData.OD_UPSL_MATRIX.THE_LOWEST_INBOUND_NO_REFUND;}else{oppositeBoundSelected=clientSideData.OD_UPSL_MATRIX.THE_LOWEST_INBOUND;}}selfFromOutbound=true;}else{oppositeBoundSelected=getInOutForMatrix("outbound");if(typeof oppositeBoundSelected==="undefined"){if(clientSideData.IS_PAID_ASYNC||clientSideData.ELIGIBLE_FOR_NO_REFUND_REBOOKING){oppositeBoundSelected=clientSideData.OD_UPSL_MATRIX.THE_LOWEST_OUTBOUND_NO_REFUND;}else{oppositeBoundSelected=clientSideData.OD_UPSL_MATRIX.THE_LOWEST_OUTBOUND;}}selfFromOutbound=false;}}$.each((self).parent("tr").find("td.ff"),function(){if(isOneBoundChange){var rebookFeeValue=$(this).data("cellRebookFee");}else{if(selfFromOutbound&&clientSideData.OD_UPSL_MATRIX[newSelection][oppositeBoundSelected]!==undefined){var rebookFeeValue=clientSideData.OD_UPSL_MATRIX[newSelection][oppositeBoundSelected].LIST_PNR_PRICE[0].REBOOK_FEE.TOTAL_AMOUNT;}else{if(clientSideData.OD_UPSL_MATRIX[oppositeBoundSelected][newSelection]!==undefined){var rebookFeeValue=clientSideData.OD_UPSL_MATRIX[oppositeBoundSelected][newSelection].LIST_PNR_PRICE[0].REBOOK_FEE.TOTAL_AMOUNT;}else{var rebookFeeValue=$(this).data("cellRebookFee");}}}if(parseInt(rebookFeeValue)==0){var rebookingFee=clientMessages["ALLP.text.RebookingFeeWaived"];}else{var rebookingFee=clientMessages["ALLP.text.RebookingFeePayOnly"].replace("{0}",theUtils.formatPriceWithCurrency(rebookFeeValue,clientSideData.CURRENCY_CODE));}record.Row.Data.ff_values.push(rebookingFee);});}else{record.Row.Data.ff_values=_benefitsValues[_benefitsInfo[key].name];}}else{record.Row.Data.ff_values=_benefitsValues[_benefitsInfo[key].name];}config[config.length]=record;}}var availableSections=["outbound","inbound"];var closestTable=self.closest("table");var section_name;for(key in availableSections){if(typeof availableSections[key]!="function"&&availableSections.hasOwnProperty(key)){if(closestTable.attr("class").match(availableSections[key])){section_name=availableSections[key];}}}if(typeof CoUpslPage.prototype.flightDetailsObs[section_name]=="undefined"){CoUpslPage.prototype.flightDetailsObs[section_name]=flightDetailsFactory.create($("."+section_name),{"hide":clientMessages[clientSideData.MSG_PAGE_CODE+".text.HideBenefits"],"show":clientMessages[clientSideData.MSG_PAGE_CODE+".text.ShowBenefits"],"teaserMessage":clientMessages[clientSideData.MSG_PAGE_CODE+".pattern.TeaserTemplateText"],"teaserMessageNegative":clientMessages[clientSideData.MSG_PAGE_CODE+".pattern.NegativeTeaserTemplateText"],"currency":clientMessages["GLBL.currency.symbol."+clientSideData.CURRENCY_CODE],"upgrade":clientMessages[clientSideData.MSG_PAGE_CODE+".text.UpgradeBenefits"],"baggageAllowanceLink":clientMessages["ALLP.text.BaggageAllowanceLink."+clientSideData["WDS_MARKET"]]});}var tmpFlightNr=getFlightNrOnUpslPage(self);var tmpBenefits=displayBenefits(self);CoUpslPage.prototype.flightDetailsObs[section_name].update(config,self,self.parent().find("td.ff").index(self),tmpFlightNr,tmpBenefits);checkVcp(self);checkConnectionInDifferentAirport(self);};var getInOutForMatrix=function(bound){var el=$("."+bound).find(".selectedFF");if(el.length>0){return el.attr("class").match(/ff-(\w+)/)[1]+"_"+el.parent().attr("class").match(/flightId-(\d+)/)[1];}else{null;}};var displayBenefits=function(tdElem){var result=[];var allBenefits=[true,true,true,true,true];var pureJJBenefits=clientSideData.WDS_BENEFITS_FOR_PURE_TAM;var groupJJBenefits=clientSideData.WDS_BENEFITS_FOR_TAM_GROUP;var pureLABenefits=clientSideData.WDS_BENEFITS_FOR_PURE_LAN;var groupLABenefits=clientSideData.WDS_BENEFITS_FOR_LAN_GROUP;var otherBenefits=clientSideData.WDS_BENEFITS_FOR_OTHERS;var tamGroup=clientSideData.WDS_AIRLINES_TAM_GROUP;var lanGroup=clientSideData.WDS_AIRLINES_LAN_GROUP;if("M"!=clientSideData.TRIP_TYPE&&!clientSideData.IS_REDEMPTION&&typeof clientSideData.WDS_DISABLE_BENEFITS_FOR_CODE_SHARE!=="undefined"&&!clientSideData.WDS_DISABLE_BENEFITS_FOR_CODE_SHARE){tdElem.parent().find("td.ff").each(function(index){var calculateBenefits=function(parent){var flightOperatedBy=parent.data("operatedby");var flightMarketedBy=parent.data("airlinecode");var duration=~~parent.data("rpduration").trim();var benefits={availability:otherBenefits,purejj:false,duration:duration};if("JJ"==flightMarketedBy){if("JJ"==flightOperatedBy){benefits.purejj=true;benefits.availability=pureJJBenefits;}else{if(-1!=tamGroup.indexOf(flightOperatedBy)){benefits.availability=groupJJBenefits;}}}else{if("LA"==flightMarketedBy){if("LA"==flightMarketedBy){benefits.availability=pureLABenefits;}else{if(-1!=lanGroup.indexOf(flightOperatedBy)){benefits.availability=groupLABenefits;}}}}return benefits;};var parent=tdElem.parent();var benefits=calculateBenefits(parent);while(typeof parent.next()!=="undefined"&&parent.next().is("tr")&&parent.next().hasClass("flightNextSegment")){parent=parent.next();if($(".linkFlif",$(parent)).size()>0){otherBenefits=calculateBenefits(parent);if(!clientSideData.IS_OWD){if(!benefits.purejj&&otherBenefits.purejj){benefits=otherBenefits;}}else{if(benefits.duration<otherBenefits.duration){benefits=otherBenefits;}}}}result[index]=benefits.availability;});}else{tdElem.parent().find("td.ff").each(function(index){var fareFamily=$(this).data("cell-fare-family");result[index]=allBenefits;});}return result;};var checkVcp=function(tdElem){var warning=tdElem.parent().parent().find("tr.details.vcp td div").errorPanel();if(jQuery.trim(clientSideData.B_LOCATION_1)==="SAO"||jQuery.trim(clientSideData.E_LOCATION_1)==="SAO"||jQuery.trim(clientSideData.B_LOCATION_1)==="VCP"||jQuery.trim(clientSideData.E_LOCATION_1)==="VCP"){var checkCondition=function(parent){return jQuery.trim(parent.find(".bLocation").text())=="VCP"||jQuery.trim(parent.find(".eLocation").text())=="VCP";};var parent=tdElem.parent();var vcp=false;if(checkCondition(parent)){vcp=true;}while(typeof parent.next()!="undefined"&&parent.next().is("tr")&&parent.next().hasClass("flightNextSegment")){parent=parent.next();if(checkCondition(parent)){vcp=true;}}if(vcp){warning.errorPanel("addError",null,null,clientMessages[clientSideData.MSG_PAGE_CODE+".text.WarningVCP"]);warning.parent().parent().removeClass("none");}else{warning.errorPanel("removeError",null,null,clientMessages[clientSideData.MSG_PAGE_CODE+".text.WarningVCP"]);warning.parent().parent().addClass("none");}}};var checkConnectionInDifferentAirport=function(tdElem){var warning=tdElem.parent().parent().find("tr.details.connectionindifferentairportwarning td div").errorPanel();var checkConnectionInDifferentAirportCondition=function(parent,parentNext){return((parent.data("arrivalairportcode")!=parentNext.data("departureairportcode"))&&(parent.data("arrivalcitycode")==parentNext.data("departurecitycode")));};var parent=tdElem.parent();var nextTr;var isConnectionInDifferentAirport=false;while(typeof parent.next()!="undefined"&&parent.next().is("tr")&&parent.next().hasClass("flightNextSegment")&&parent.next().hasClass("stopDuration")&&!parent.next().hasClass("totalDuration")){if(typeof parent.next().next()!="undefined"&&parent.next().next().is("tr")&&parent.next().next().hasClass("flightNextSegment")){nextTr=parent.next().next();}else{nextTr="undefined";}if(nextTr!="undefined"&&checkConnectionInDifferentAirportCondition(parent,nextTr)){isConnectionInDifferentAirport=true;}parent=nextTr;}if(isConnectionInDifferentAirport){warning.errorPanel("addError",null,null,clientMessages[clientSideData.MSG_PAGE_CODE+".text.WarningConnectionInDifferentAirport"]);warning.parent().parent().removeClass("none");}else{warning.errorPanel("removeError",null,null,clientMessages[clientSideData.MSG_PAGE_CODE+".text.WarningConnectionInDifferentAirport"]);warning.parent().parent().addClass("none");}};var showToolitpOnUncombinable=function(){var el=$("table.bound .uncomb").parent();el.qtip({content:{text:"<p>"+clientMessages[clientSideData.MSG_PAGE_CODE+".text.tootipUncombinable"]+"</p>"},position:{my:"bottom center",at:"top center"},events:{show:function(event,api){if(api.elements.target.find(".uncomb").length<=0){return false;}}}});};var fillFareFormForAtcOneBoundChange=function(self){var closestTable=self.closest("table.bound");var fareForm=$("#FARE_FORM");if(closestTable.hasClass("outbound")){var reco_1=fareForm.input("RECOMMENDATION_ID_1");var flight_1=fareForm.input("FLIGHT_ID_1");var flight_2=fareForm.input("FLIGHT_ID_2");reco_1.value($(self).attr("data-cell-reco-id"));if($(self).attr("data-cell-flight-id-1")!=""){flight_1.value($(self).attr("data-cell-flight-id-1"));}else{flight_1.value($(self).attr("data-cell-flight-id"));}if($("table.bound.inbound").length==0){flight_2.value($(self).attr("data-cell-flight-id-2"));}}else{var reco_1=fareForm.input("RECOMMENDATION_ID_1");var flight_1=fareForm.input("FLIGHT_ID_1");var flight_2=fareForm.input("FLIGHT_ID_2");reco_1.value($(self).attr("data-cell-reco-id"));flight_2.value($(self).attr("data-cell-flight-id-2"));if($("table.bound.outbound").length==0){flight_1.value($(self).attr("data-cell-flight-id-1"));}}};var getFlightsChoice=function(self,closestTable){var flightsChoice={};if(closestTable.hasClass("outbound")){flightsChoice["outboundFF"]=$(self).attr("data-cell-fare-family");if($("table.bound.inbound").length!=0&&$("table.bound.inbound .selectedFF").length!=0){flightsChoice["inboundFF"]=$("table.bound.inbound .selectedFF").attr("data-cell-fare-family");flightsChoice["inboundFlightId"]=$("table.bound.inbound .selectedFF").attr("data-cell-flight-id");}flightsChoice["outboundFlightId"]=$(self).attr("data-cell-flight-id");}else{flightsChoice["inboundFF"]=$(self).attr("data-cell-fare-family");if($("table.bound.outbound").length!=0&&$("table.bound.outbound .selectedFF").length!=0){flightsChoice["outboundFF"]=$("table.bound.outbound .selectedFF").attr("data-cell-fare-family");flightsChoice["outboundFlightId"]=$("table.bound.outbound .selectedFF").attr("data-cell-flight-id");}flightsChoice["inboundFlightId"]=$(self).attr("data-cell-flight-id");}if(clientSideData.IS_OWD&&clientSideData.IS_ROUND_TRIP&&typeof clientSideData.OD_UPSL_MATRIX!=="undefined"&&typeof flightsChoice.outboundFF!=="undefined"&&typeof flightsChoice.outboundFlightId!=="undefined"&&typeof flightsChoice.inboundFF!=="undefined"&&typeof flightsChoice.inboundFlightId!=="undefined"){odUpslMatrixCell=clientSideData.OD_UPSL_MATRIX[flightsChoice.outboundFF+"_"+flightsChoice.outboundFlightId][flightsChoice.inboundFF+"_"+flightsChoice.inboundFlightId];if(typeof odUpslMatrixCell!=="undefined"){var recoId=odUpslMatrixCell.RECOMMENDATION_ID;flightsChoice["recoId1"]=recoId;}}else{if(typeof $("table.bound.outbound .selectedFF").attr("data-cell-reco-id")!=="undefined"){flightsChoice["recoId1"]=$("table.bound.outbound .selectedFF").attr("data-cell-reco-id");}if(typeof $("table.bound.inbound .selectedFF").attr("data-cell-reco-id")!=="undefined"){flightsChoice["recoId2"]=$("table.bound.inbound .selectedFF").attr("data-cell-reco-id");}}return flightsChoice;};var prefillFareForm=function(fareForm,flightsChoice){if(typeof flightsChoice.recoId1!=="undefined"){var reco_1=fareForm.input("RECOMMENDATION_ID_1");reco_1.value(flightsChoice.recoId1);}if(typeof flightsChoice.recoId2!=="undefined"){var reco_2=fareForm.input("RECOMMENDATION_ID_2");reco_2.value(flightsChoice.recoId2);}else{var reco_2=fareForm.input("RECOMMENDATION_ID_2");reco_2.value("");}if(typeof flightsChoice.outboundFlightId!=="undefined"){var flight_1=fareForm.input("FLIGHT_ID_1");flight_1.value(flightsChoice.outboundFlightId);}if(typeof flightsChoice.inboundFlightId!=="undefined"){var flight_2=fareForm.input("FLIGHT_ID_2");flight_2.value(flightsChoice.inboundFlightId);}};var getDiscountFromLTT=function(listTravelerType){var ret=undefined;var code=[];var amount=[];for(var key in listTravelerType[0].LIST_BOUND){if(listTravelerType[0].LIST_BOUND.hasOwnProperty(key)){var ticketDesignator=listTravelerType[0].LIST_BOUND[key].LIST_SEGMENT[0].TICKET_DESIGNATOR;if(typeof ticketDesignator!=="undefined"){code.push(getFromTicketDesignator(ticketDesignator,"CODE"));amount.push(getFromTicketDesignator(ticketDesignator,"AMOUNT"));}else{break;}}}if(typeof code!=="undefined"&&(amount[0]!=0||amount[1]!=0)){ret={code:code,amount:amount};}return ret;};var getFromTicketDesignator=function(ticketDesignator,ret){if(ret=="CODE"){return ticketDesignator.substr(0,1);}else{if(ret=="AMOUNT"){return ~~ticketDesignator.substr(1,ticketDesignator.length);}}};var getBoundInfoForRpFromTr=function(tr){return{"flightNumber":jQuery.trim(tr.find("td.flightNumber a").text()),"date":parseInt(jQuery.trim(tr.data("departuretime"))),"from":{"cityCode":jQuery.trim(tr.data("departurecitycode")),"airportCode":jQuery.trim(tr.data("departureairportcode")),"date":parseInt(jQuery.trim(tr.data("departuretime"))),"time":parseInt(jQuery.trim(tr.data("departuretime")))},"to":{"cityCode":jQuery.trim(tr.data("arrivalcitycode")),"airportCode":jQuery.trim(tr.data("arrivalairportcode")),"date":parseInt(jQuery.trim(tr.data("arrivaltime"))),"time":parseInt(jQuery.trim(tr.data("arrivaltime")))},"duration":parseInt(jQuery.trim(tr.data("rpduration"))),"aircraft":jQuery.trim(tr.data("aircraft")),"baggageAllowance":tr.data("baggageAllowance"),"baggageAllowanceLink":tr.data("baggageAllowanceLink"),"operatedBy":tr.data("operatedby"),"operatedByAirlineName":tr.data("operatedbyairlinename"),"anacLink":tr.data("anacLink"),"ontimePerformance":tr.data("ontimePerformance"),"airlineCompany":tr.data("airlinecompany"),"numberOfStops":tr.data("numberOfStops"),"nextDay":tr.data("nextday")};};var performActionOnClick=function(td,closestTable,controller,tr,trId){if(td.hasClass("uncombinable")){td.qtip("destroy").find(".uncomb").remove();var boundId;if(closestTable.hasClass("outbound")){boundId=1;$(".inbound .flight").each(function(){controller.updatePricesFotOppositeBound($(this),"inbound-uncombinable");});}else{boundId=0;$(".outbound .flight").each(function(){controller.updatePricesFotOppositeBound($(this),"outbound-uncombinable");});}showToolitpOnUncombinable();var bounds=[];if(tr.parents("table[id*='_list_flight_direct']").length>0){bounds[bounds.length]=getBoundInfoForRpFromTr(tr);}else{while(typeof tr.next()!="undefined"&&(tr.hasClass(trId)||(tr.is("tr")&&tr.hasClass("flightNextSegment")||tr.hasClass("flight")))||(tr.hasClass("stopDuration")||tr.hasClass("totalDurationRow"))){if(!(tr.hasClass("stopDuration")||tr.hasClass("totalDurationRow"))){bounds[bounds.length]=getBoundInfoForRpFromTr(tr);}tr=tr.next();}}var styles=gerFFs(closestTable,td);var data={"boundId":(boundId==0)?1:0,"segments":bounds,"ff":styles.name,"ffCode":styles.code,"totalDuration":jQuery.trim(td.data("cellTotalDuration"))};closestTable.find("small.uncomb").remove();$(document).trigger("showBoundAsUncombinable",{"boundId":boundId});$(document).trigger("updateBound",data);$(document).trigger("clearTotalPrices");return false;}else{if(closestTable.hasClass("outbound")){$(".inbound .flight").each(function(){controller.updatePricesFotOppositeBound($(this),"inbound");});}else{$(".outbound .flight").each(function(){controller.updatePricesFotOppositeBound($(this),"outbound");});}showToolitpOnUncombinable();}return true;};var gerFFs=function(tbl,td){var ffTh=tbl.parent().find("thead tr th.family").eq(td.parent().find("td.ff").index(td));var FFName=ffTh.data("ffTranslatedname");var FFCode=ffTh.attr("class").match(/f_(\w+)/)[1];return{name:FFName,code:FFCode};};return function(self){$("#CC_CURRENCY_TO").val("");var theCoUpsl=this;var flightsChoice={};self.addClass("selectedFF");var ffIndex=self.closest("table").parent().find("th").eq(self.index()).data("ffIndex")+1;self.addClass("family"+ffIndex);self.find("a.readPriceHack").attr("title");if($(self).parent().parent().parent().hasClass("outbound")){$(".outbound").find("a.readPriceHack.selected").attr("title",$(".outbound").find("a.readPriceHack.selected").data("unselectedTitle"));$(".outbound").find("a.readPriceHack.selected").removeClass("selected");}else{$(".inbound").find("a.readPriceHack.selected").attr("title",$(".inbound").find("a.readPriceHack.selected").data("unselectedTitle"));$(".inbound").find("a.readPriceHack.selected").removeClass("selected");}self.find("a.readPriceHack").addClass("selected");self.find("a.readPriceHack").attr("title",self.find("a.readPriceHack").attr("title")+" "+clientMessages[clientSideData.PAGE_CODE+".text.selectedFareFamily"]);var closestTable=self.closest("table.bound");var fareForm=$("#FARE_FORM");if(clientSideData.IS_ATC&&($("table.bound.inbound").length==0||$("table.bound.outbound").length==0)){fillFareFormForAtcOneBoundChange(self);}else{flightsChoice=getFlightsChoice(self,closestTable);prefillFareForm(fareForm,flightsChoice);}var tbody=self.closest("tbody");if(!tbody.is(":visible")){tbody.removeClass("none").prev().removeClass("none");}var anel={};var tr=self.parent();var trId=tr.attr("class").match(/flightId-\d+/)[0];var boundRP=[];var closestTable=self.closest("table.bound");var $this=this;clickIterator++;$("table.bound:not(#inbound_list_flight_direct, #outbound_list_flight_direct)").each(function(){var selected=$(this).find(".selectedFF");var caption=$(this).prev();if(selected.length>0){caption.removeClass("toggle");caption.find("small.ico").addClass("none");}else{caption.addClass("toggle");caption.find("small.ico").removeClass("none");}});if(clientSideData.IS_OWD&&clickIterator>2){var configLN=[{"title":clientMessages[clientSideData.MSG_PAGE_CODE+".text.WaitMessage"],"text":clientMessages[clientSideData.MSG_PAGE_CODE+".text.UpdatePriceMessage"]}];var closestTable=self.closest("table.bound");if(!closestTable.next().hasClass("noBoundTemplateClass")){if($(".ui-widget-overlay").length==0){var popin=$(tamUtils.getElementForTmpls(template_waitPanel.tmpl(configLN)));popin.dialog({autoOpen:true,draggable:false,height:330,width:640,modal:true,resizable:false,closeOnEscape:false,open:function(event,ui){$(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").hide();}});setTimeout(function(){popin.remove();flightDetailsFn(self);},2000);}else{setTimeout(function(){flightDetailsFn(self);},1);}}else{flightDetailsFn(self);}if(!performActionOnClick(self,closestTable,$this,tr,trId)){return false;}}else{flightDetailsFn(self);}if(clientSideData.IS_OWD&&clickIterator==0){return;}else{if(clientSideData.IS_OWD&&clickIterator==1){var closestTable=self.closest("table.bound");if(!performActionOnClick(self,closestTable,$this,tr)){return false;}}}if(closestTable.hasClass("outbound")){theCoUpsl.rightPanel.boundId="0";}else{theCoUpsl.rightPanel.boundId="1";}var iter=0;while(typeof tr.next()!="undefined"&&(tr.hasClass(trId)||(tr.is("tr")&&tr.hasClass("flightNextSegment")))||(tr.hasClass("stopDuration")||tr.hasClass("totalDurationRow"))){if(!(tr.hasClass("stopDuration")||tr.hasClass("totalDurationRow"))){var styles=gerFFs(closestTable,self);var FFName=styles.name;var FFCode=styles.code;var rbd=jQuery.trim(self.data("cell-rbd-"+iter));var cabin=jQuery.trim(self.data("cell-cabin-"+iter));var totalDuration=jQuery.trim(self.data("cellTotalDuration"));if(clientSideData.IS_OWD){var idxOutbound=undefined;var idxInbound=undefined;if(typeof getInOutForMatrix("outbound")!=="undefined"&&typeof getInOutForMatrix("inbound")!=="undefined"){idxOutbound=getInOutForMatrix("outbound");idxInbound=getInOutForMatrix("inbound");}if(typeof getInOutForMatrix("outbound")!=="undefined"&&typeof getInOutForMatrix("inbound")==="undefined"){idxOutbound=getInOutForMatrix("outbound");idxInbound=clientSideData.OD_UPSL_MATRIX.THE_LOWEST_INBOUND;}if(typeof getInOutForMatrix("outbound")==="undefined"&&typeof getInOutForMatrix("inbound")!=="undefined"){idxOutbound=clientSideData.OD_UPSL_MATRIX.THE_LOWEST_OUTBOUND;idxInbound=getInOutForMatrix("inbound");}upslMatrixOutbound=clientSideData.OD_UPSL_MATRIX[idxOutbound];if(upslMatrixOutbound){upslMatrixInbound=upslMatrixOutbound[idxInbound];if(upslMatrixInbound){rbd=upslMatrixInbound.LIST_TRAVELLER_TYPE[0].LIST_BOUND[theCoUpsl.rightPanel.boundId].LIST_SEGMENT[iter].RBD;cabin=upslMatrixInbound.LIST_TRAVELLER_TYPE[0].LIST_BOUND[theCoUpsl.rightPanel.boundId].LIST_SEGMENT[iter].CABIN;}}self.data("cell-rbd-"+iter,rbd);self.data("cell-cabin-"+iter,cabin);}var boundRpId=boundRP.length;boundRP[boundRpId]=getBoundInfoForRpFromTr(tr);boundRP[boundRpId]["cabin"]=cabin;boundRP[boundRpId]["totalDuration"]=totalDuration;iter++;}tr=tr.next();}theCoUpsl.rightPanel.segments=boundRP;theCoUpsl.rightPanel.ff=jQuery.trim(FFName);theCoUpsl.rightPanel.ffCode=jQuery.trim(FFCode);theCoUpsl.rightPanel.totalDuration=totalDuration;$(document).trigger("updateBound",theCoUpsl.rightPanel);if(!clientSideData.IS_REDEMPTION){var rpConfig=$this.getRPTeaserConfig();if(rpConfig.show){var rightPanelUpslTeaser={currencyCode:clientSideData.CURRENCY_CODE,diff:rpConfig.diff,ff:rpConfig.ff,ffCode:rpConfig.ffCode,upgradeCallback:rpConfig.callback};$(document).trigger("showUpsellTeaser",rightPanelUpslTeaser);}else{$(document).trigger("hideUpsellTeaser");}}var discount_adt=[];var discount_adt_code=[];var discount_adt_price=[];var discount_adt_tax=[];var price_adt=0;var price_chd=0;var price_inf=0;var tax_adt=0;var tax_chd=0;var tax_inf=0;var price_adt_original=0;var price_chd_original=0;var price_inf_original=0;var tax_adt_original=0;var tax_chd_original=0;var tax_inf_original=0;var totalRefunded=0;var totalToBePaid=0;var rebookFee=0;var cellValue=0;if(clientSideData.PAGE_CODE=="ATC_UPSL"&&clientSideData.ORIGINAL_PRICE!=undefined&&clientSideData.ORIGINAL_PRICE.ORIGINAL_PRICE_AVAILABLE!=undefined){var originalPriceDataAvailable=clientSideData.ORIGINAL_PRICE.ORIGINAL_PRICE_AVAILABLE;var originalTotalPrice=clientSideData.ORIGINAL_PRICE.ORIGINAL_TOTAL_PRICE;var originalCurrency=clientSideData.ORIGINAL_PRICE.ORIGINAL_CURRENCY;}if(clientSideData.IS_OWD){if(typeof getInOutForMatrix("outbound")!=="undefined"&&typeof getInOutForMatrix("inbound")!=="undefined"){var listTravelerType=clientSideData.OD_UPSL_MATRIX[getInOutForMatrix("outbound")][getInOutForMatrix("inbound")].LIST_TRAVELLER_TYPE;for(var keyLTT in listTravelerType){if(listTravelerType.hasOwnProperty(keyLTT)&&-1<keyLTT){if(listTravelerType[keyLTT].TRAVELLER_TYPE.CODE=="ADT"){price_adt=listTravelerType[keyLTT].LIST_TRAVELLER_TYPE_PRICE[0]["AMOUNT_WITHOUT_TAX"]/listTravelerType[keyLTT].NUMBER;tax_adt=listTravelerType[keyLTT].LIST_TRAVELLER_TYPE_PRICE[0].TAX/listTravelerType[keyLTT].NUMBER;var r=getDiscountFromLTT(listTravelerType);if(typeof r!=="undefined"){discount_adt=r.amount;discount_adt_code=r.code;discount_adt_price[0]=listTravelerType[keyLTT].LIST_TRAVELLER_TYPE_PRICE[0]["LIST_BOUND_PRICE"][0]["AMOUNT_WITHOUT_TAX"];if(listTravelerType[keyLTT].LIST_TRAVELLER_TYPE_PRICE[0]["LIST_BOUND_PRICE"].length==2){discount_adt_price[1]=listTravelerType[keyLTT].LIST_TRAVELLER_TYPE_PRICE[0]["LIST_BOUND_PRICE"][1]["AMOUNT_WITHOUT_TAX"];}}}else{if(listTravelerType[keyLTT].TRAVELLER_TYPE.CODE=="CHD"){price_chd=listTravelerType[keyLTT].LIST_TRAVELLER_TYPE_PRICE[0]["AMOUNT_WITHOUT_TAX"]/listTravelerType[keyLTT].NUMBER;tax_chd=listTravelerType[keyLTT].LIST_TRAVELLER_TYPE_PRICE[0].TAX/listTravelerType[keyLTT].NUMBER;}else{if(listTravelerType[keyLTT].TRAVELLER_TYPE.CODE=="INF"){price_inf=listTravelerType[keyLTT].LIST_TRAVELLER_TYPE_PRICE[0]["AMOUNT_WITHOUT_TAX"]/listTravelerType[keyLTT].NUMBER;tax_inf=listTravelerType[keyLTT].LIST_TRAVELLER_TYPE_PRICE[0].TAX/listTravelerType[keyLTT].NUMBER;}}}if(typeof listTravelerType[keyLTT].LIST_TRAVELLER_PRICE[0].REBOOK_FEE!=="undefined"){rebookFee+=listTravelerType[keyLTT].LIST_TRAVELLER_PRICE[0].REBOOK_FEE.TOTAL_AMOUNT;}}}var isNew="";if(clientSideData.PAGE_CODE=="ATC_UPSL"){totalRefunded=clientSideData.OD_UPSL_MATRIX[getInOutForMatrix("outbound")][getInOutForMatrix("inbound")].LIST_PNR_PRICE[0].REFUND_BALANCE.AMOUNT;isNew="New";}if(jQuery.trim($(this).data("cellPriceAdt"))!=""){price_adt+=parseFloat(jQuery.trim($(this).data("cellPriceAdt"+isNew)));}if(jQuery.trim($(this).data("cellPriceChd"))!=""){price_chd+=parseFloat(jQuery.trim($(this).data("cellPriceChd"+isNew)));}if(jQuery.trim($(this).data("cellPriceInf"))!=""){price_inf+=parseFloat(jQuery.trim($(this).data("cellPriceInf"+isNew)));}if(jQuery.trim($(this).data("cellTaxAdt"))!=""){tax_adt+=parseFloat(jQuery.trim($(this).data("cellTaxAdt")));}if(jQuery.trim($(this).data("cellTaxChd"))!=""){tax_chd+=parseFloat(jQuery.trim($(this).data("cellTaxChd")));}if(jQuery.trim($(this).data("cellTaxInf"))!=""){tax_inf+=parseFloat(jQuery.trim($(this).data("cellTaxInf")));}if(clientSideData.PAGE_CODE=="ATC_UPSL"){totalToBePaid=clientSideData.OD_UPSL_MATRIX[getInOutForMatrix("outbound")][getInOutForMatrix("inbound")].LIST_PNR_PRICE[0].TOTAL_COLLECT_BALANCE.AMOUNT;var cellRebookFee=clientSideData.OD_UPSL_MATRIX[getInOutForMatrix("outbound")][getInOutForMatrix("inbound")].LIST_PNR_PRICE[0].REBOOK_FEE.TOTAL_AMOUNT;if(cellRebookFee!=""){rebookFee=parseFloat(jQuery.trim(cellRebookFee));}price_adt_original=clientSideData.ORIGINAL_PRICE.PRICE_ADT;price_chd_original=clientSideData.ORIGINAL_PRICE.PRICE_CHD;price_inf_original=clientSideData.ORIGINAL_PRICE.PRICE_INF;tax_adt_original=clientSideData.ORIGINAL_PRICE.TAX_ADT;tax_chd_original=clientSideData.ORIGINAL_PRICE.TAX_CHD;tax_inf_original=clientSideData.ORIGINAL_PRICE.TAX_INF;}}}else{var idx=0;$("td.selectedFF").each(function(){var isNew="";if(clientSideData.PAGE_CODE=="ATC_UPSL"){isNew="New";}if(jQuery.trim($(this).data("cellPriceAdt"))!=""){price_adt+=parseFloat(jQuery.trim($(this).data("cellPriceAdt"+isNew)));}if(jQuery.trim($(this).data("cellPriceChd"))!=""){price_chd+=parseFloat(jQuery.trim($(this).data("cellPriceChd"+isNew)));}if(jQuery.trim($(this).data("cellPriceInf"))!=""){price_inf+=parseFloat(jQuery.trim($(this).data("cellPriceInf"+isNew)));}if(jQuery.trim($(this).data("cellTaxAdt"))!=""){tax_adt+=parseFloat(jQuery.trim($(this).data("cellTaxAdt")));}if(jQuery.trim($(this).data("cellTaxChd"))!=""){tax_chd+=parseFloat(jQuery.trim($(this).data("cellTaxChd")));}if(jQuery.trim($(this).data("cellTaxInf"))!=""){tax_inf+=parseFloat(jQuery.trim($(this).data("cellTaxInf")));}discount_adt_code.push(undefined);discount_adt_price.push(0);discount_adt.push(0);discount_adt_tax.push(0);var tkDesignator=jQuery.trim($(this).data("cellTicketDesignator"));if(tkDesignator!=""){var factorK=1;if(tkDesignator.substring(tkDesignator.length-1)=="K"){factorK=1000;}var discountNumber=parseFloat(tkDesignator.substr(1))*factorK;if(discountNumber>0){if(jQuery.trim($(this).data("cellPriceAdt"))!=""){discount_adt_price[idx]=parseFloat(jQuery.trim($(this).data("cellPriceAdt"+isNew)));}if(jQuery.trim($(this).data("cellTaxAdt"))!=""){discount_adt_tax[idx]=parseFloat(jQuery.trim($(this).data("cellTaxAdt")));}discount_adt[idx]=discountNumber;discount_adt_code[idx]=jQuery.trim($(this).data("cellTicketDesignator")).substr(0,1);}}if(clientSideData.PAGE_CODE=="ATC_UPSL"){totalToBePaid+=parseFloat(jQuery.trim($(this).data("cellCollectBalance")));if(jQuery.trim($(this).data("cellRebookFee"))!=""){rebookFee=parseFloat(jQuery.trim($(this).data("cellRebookFee")));}price_adt_original=clientSideData.ORIGINAL_PRICE.PRICE_ADT;price_chd_original=clientSideData.ORIGINAL_PRICE.PRICE_CHD;price_inf_original=clientSideData.ORIGINAL_PRICE.PRICE_INF;tax_adt_original=clientSideData.ORIGINAL_PRICE.TAX_ADT;tax_chd_original=clientSideData.ORIGINAL_PRICE.TAX_CHD;tax_inf_original=clientSideData.ORIGINAL_PRICE.TAX_INF;if(jQuery.trim($(this).data("cellRefundBalance"))!=""){totalRefunded=parseFloat(jQuery.trim($(this).data("cellRefundBalance")));}}idx+=1;});}if(clientSideData.PAGE_CODE=="ATC_UPSL"){CoUpslPage.prototype.totalToBePaid=totalToBePaid;var pricesRP={originalPriceDataAvailable:originalPriceDataAvailable,originalTotalPrice:originalTotalPrice,originalCurrency:originalCurrency,currencyCode:clientSideData.CURRENCY_CODE,totalRefunded:totalRefunded,totalToBePaid:totalToBePaid,newPrice:{total:cellValue,adults:{count:clientSideData.ADULTS_NR,price:{withoutTax:price_adt,tax:tax_adt}},children:{count:clientSideData.CHILDREN_NR,price:{withoutTax:price_chd,tax:tax_chd}},infants:{count:clientSideData.INFANTS_NR,price:{withoutTax:price_inf,tax:tax_inf}},discount:{type:discount_adt_code,amount:discount_adt},rebook:{price:rebookFee}},originalPrice:{adults:{count:clientSideData.ADULTS_NR,price:{withoutTax:price_adt_original,tax:tax_adt_original}},children:{count:clientSideData.CHILDREN_NR,price:{withoutTax:price_chd_original,tax:tax_chd_original}},infants:{count:clientSideData.INFANTS_NR,price:{withoutTax:price_inf_original,tax:tax_inf_original}},discount:{type:[undefined],amount:[0],price:0}}};}else{var pricesRP={currencyCode:clientSideData.CURRENCY_CODE,adults:{count:clientSideData.ADULTS_NR,price:{withoutTax:clientSideData.ADULTS_NR*price_adt,tax:clientSideData.ADULTS_NR*tax_adt}},children:{count:clientSideData.CHILDREN_NR,price:{withoutTax:clientSideData.CHILDREN_NR*price_chd,tax:clientSideData.CHILDREN_NR*tax_chd}},infants:{count:clientSideData.INFANTS_NR,price:{withoutTax:clientSideData.INFANTS_NR*price_inf,tax:clientSideData.INFANTS_NR*tax_inf}},discount:{type:discount_adt_code,amount:discount_adt,price:discount_adt_price,tax:discount_adt_tax}};}if(clientSideData.IS_REDEMPTION){pricesRP["redemption"]=true;}$(document).trigger("updateTotals",pricesRP);$("#FARE_TOTAL_PRICE").val(rpModel.totals.grandTotal.amount);};})();CoUpslPage.prototype.showTooltipForBounds=function(){$("table.bound .bLocation, table.bound .eLocation").each(function(){var prefix=($(this).hasClass("bLocation"))?"b":"e";$(this).qtip({content:{text:"<p>"+$(this).parent().parent().data(prefix+"locationfull")+" ("+$(this).text()+")"+"</p>"},position:{my:"bottom center",at:"top center"}});});};CoUpslPage.prototype.getRPTeaserConfig=function(){var config={};var error="Error with RP teaser";var getInfoFromCell=function(cell){if(cell.length!=1){throw new Error(error);}var ffPattern=/ff-(\w+)/;var indexPattern=/index-(\d+)/;var ff=cell.attr("class").match(ffPattern)[1];var index=cell.attr("class").match(indexPattern)[1];if(typeof index==="undefined"||typeof ff==="undefined"){throw new Error(error);}index=~~index;return{ff:ff,index:index};};var getPriceForCell=function(cell,nextCell){if(nextCell.hasClass("disabled")||nextCell.hasClass("uncombinable")){throw new Error(error);}var currentPrice=jQuery.trim(cell.data("cellValue"));var nextPrice=jQuery.trim(nextCell.data("cellValue"));return nextPrice-currentPrice;};var getPriceForOwdCells=function(outCell,inCell){var idPatt=/flightId-(\d+)/;var ffPatt=/ff-(\w+)/;var outKey=outCell.attr("class").match(ffPatt)[1]+"_"+outCell.parent().attr("class").match(idPatt)[1];var inKey=inCell.attr("class").match(ffPatt)[1]+"_"+inCell.parent().attr("class").match(idPatt)[1];var price=0;if(typeof clientSideData.OD_UPSL_MATRIX[outKey]!=="undefined"&&typeof clientSideData.OD_UPSL_MATRIX[outKey][inKey]!=="undefined"){price=parseFloat(clientSideData.OD_UPSL_MATRIX[outKey][inKey].LIST_TRAVELLER_TYPE[0].LIST_TRAVELLER_PRICE[0].LIST_BOUND_PRICE[0][clientSideData.PRICE_TYPE])+parseFloat(clientSideData.OD_UPSL_MATRIX[outKey][inKey].LIST_TRAVELLER_TYPE[0].LIST_TRAVELLER_PRICE[0].LIST_BOUND_PRICE[1][clientSideData.PRICE_TYPE]);}if(price==0){throw new Error(error);}return price;};try{var price=0;var ff="";var callback;var outCell=$("table.outbound.bound .selectedFF");var inCell=$("table.inbound.bound .selectedFF");if(!clientSideData.IS_ROUND_TRIP){var outBound=getInfoFromCell(outCell);if(typeof outBound!=="undefined"){var nextOutbound=getInfoFromCell(outCell.next());if(typeof nextOutbound!=="undefined"){ff=nextOutbound.ff;}var outBound=getPriceForCell(outCell,outCell.next());if(typeof outBound!=="undefined"){price=outBound;}callback=function(){outCell.next().trigger("click");};}}else{var outBound=getInfoFromCell(outCell);var inBound=getInfoFromCell(inCell);if(typeof inBound!=="undefined"&&typeof outBound!=="undefined"){var newPrice=0;if(inBound.index==outBound.index){var nextOutbound=getInfoFromCell(outCell.next());if(typeof nextOutbound!=="undefined"){ff=nextOutbound.ff;}if(clientSideData.IS_OWD){newPrice=getPriceForOwdCells(outCell.next(),inCell.next());}else{var outBound=getPriceForCell(outCell,outCell.next());var inBound=getPriceForCell(inCell,inCell.next());if(typeof inBound!=="undefined"&&typeof outBound!=="undefined"){price=inBound+outBound;}}callback=function(){outCell.next().trigger("click");inCell.next().trigger("click");};}else{if(inBound.index>outBound.index){ff=inBound.ff;var el=outCell;for(var i=0;i<inBound.index-outBound.index;i++){el=el.next();}if(clientSideData.IS_OWD){newPrice=getPriceForOwdCells(el,inCell);}else{var outBound=getPriceForCell(outCell,el);if(typeof outBound!=="undefined"){price=outBound;}}callback=function(){el.trigger("click");};}else{if(inBound.index<outBound.index){ff=outBound.ff;var el=inCell;for(var i=0;i<outBound.index-inBound.index;i++){el=el.next();}if(clientSideData.IS_OWD){newPrice=getPriceForOwdCells(outCell,el);}else{var inBound=getPriceForCell(inCell,el);if(typeof inBound!=="undefined"){price=inBound;}}callback=function(){el.trigger("click");};}}}if(clientSideData.IS_OWD){var oldPrice=getPriceForOwdCells(outCell,inCell);price=newPrice-oldPrice;}}}price=Math.round(price*100)/100;config["ffCode"]=ff;config["diff"]=price;config["ff"]=jQuery.trim($("table.outbound td.f_"+config.ffCode).eq(0).text());config["show"]=true;config["callback"]=callback;}catch(err){config["show"]=false;}return config;};CoUpslPage.prototype.updateLowestPricePanelForOWD=function(clickedEl){if(clientSideData.IS_ROUND_TRIP&&!clientSideData.IS_REDEMPTION){var master=clickedEl.data("date");var slave=undefined;if(clickedEl.parent().hasClass("outbound")){slave=$(".calendarPricesSection.inbound ul");}else{slave=$(".calendarPricesSection.outbound ul");}var self=clickedEl;slave.each(function(){var key;var oppositeBound;if(self.parent().hasClass("outbound")){key=master+"_"+$(this).data("date");oppositeBound="INBOUND";}else{key=$(this).data("date")+"_"+master;oppositeBound="OUTBOUND";}key=key.toUpperCase();if(typeof clientSideData.CALENDAR.POPIN_MATRIX[key]!=="undefined"){if((clientSideData.CALENDAR.POPIN_MATRIX[key].INBOUND!=undefined&&clientSideData.CALENDAR.POPIN_MATRIX[key].INBOUND.OUT_OF_SCOPE==false)&&(clientSideData.CALENDAR.POPIN_MATRIX[key].OUTBOUND!=undefined&&clientSideData.CALENDAR.POPIN_MATRIX[key].OUTBOUND.OUT_OF_SCOPE==false)){var priceToInsert;if(!clientSideData.PRICE_HAS_DECIMALS&&typeof clientSideData.CALENDAR.POPIN_MATRIX.ALL_INTEGERS!=="undefined"&&clientSideData.CALENDAR.POPIN_MATRIX.ALL_INTEGERS){priceToInsert=theUtils.formatRoundedPrice(clientSideData.CALENDAR.POPIN_MATRIX[key][oppositeBound].PRICE);}else{priceToInsert=theUtils.formatPrice(clientSideData.CALENDAR.POPIN_MATRIX[key][oppositeBound].PRICE);}$(this).data("amountReference",theUtils.formatPrice(clientSideData.CALENDAR.POPIN_MATRIX[key][oppositeBound].PRICE));$(this).removeClass("disabled").find("li.tc strong").text(priceToInsert);}}else{$(this).addClass("disabled").find("li.tc strong").text(clientMessages[clientSideData.CALD_PAGE_CODE+".text.Legend.NoSeatReco"]);}});}};CoUpslPage.prototype.getOutBoundElementToInsertPriceTables=function(){var obFilterContainer=$("#0_section");if(obFilterContainer.length<1){obFilterContainer=$("#0_filters");}return obFilterContainer;};CoUpslPage.prototype.getInBoundElementToInsertPriceTables=function(){var ibFilterContainer=$("#1_section");if(ibFilterContainer.length<1){ibFilterContainer=$("#1_filters");}return ibFilterContainer;};CoUpslPage.prototype.listen=function(){var self=this;$("section.list .headerTooltip").each(function(){var message;if($(this).hasClass("yourSearch")){message=clientMessages[clientSideData.MSG_PAGE_CODE+".text.YourSearchTooltip"];}else{if($(this).hasClass("closest")){message=clientMessages[clientSideData.MSG_PAGE_CODE+".text.ClosestSearchTooltip"];}else{if($(this).hasClass("lowest")){message=clientMessages[clientSideData.MSG_PAGE_CODE+".text.LowestSearchTooltip"];}}}$(this).qtip({content:{text:"<p>"+message+"</p>"},position:{my:"bottom center",at:"top center"}});});this.showTooltipForBounds();$("section.calendarPricesSection").not(".disabled").on("click","ul",(function(event,manualTrigger){var clickBlocker=false;return function(event,manualTrigger){var target=$(this);if(manualTrigger==false&&clickBlocker==true){self.queue=event;}if(target.parent().hasClass("outbound")){$.jStorage.deleteKey("outboundPreselected");clientSideData["outboundPreselected"]=undefined;clientSideData["outboundPreselectedFlightNumber"]=null;}else{$.jStorage.deleteKey("inboundPreselected");clientSideData["inboundPreselected"]=undefined;clientSideData["inboundPreselectedFlightNumber"]=null;}if(target.hasClass("disabled")){return;}if(clickBlocker){return;}var currDate=jQuery.trim(target.find("li span").text());if(clientSideData.IS_ROUND_TRIP==true){if(target.parent().hasClass("outbound")&&$("section.inbound").length){$("section.inbound span.inboundDate").each(function(){var span=$(this);if(!span.parent().parent().hasClass("fromStart")){if(jQuery.trim(span.text())<currDate){span.parent().parent().removeClass("unselect").addClass("disabled");}else{if(!span.parent().parent().hasClass("fromStart")){var cell=span.parent().parent().removeClass("disabled");if(!cell.hasClass("selected")){cell.addClass("unselect");}}}}});}else{$("section.outbound span.outboundDate").each(function(){var span=$(this);if(!span.parent().parent().hasClass("fromStart")){if(jQuery.trim(span.text())>currDate){span.parent().parent().removeClass("unselect").addClass("disabled");}else{if(!span.parent().parent().hasClass("fromStart")){var cell=span.parent().parent().removeClass("disabled");if(!cell.hasClass("selected")){cell.addClass("unselect");}}}}});}}target.closest("section.calendarPricesSection").find("ul.selected").each(function(){var ul=$(this);ul.removeClass("selected").addClass("unselect");ul.find("li:last small").addClass("none");});target.removeClass("unselect").addClass("selected");target.find("li:last small").removeClass("none");self.removeBoundsAndShowLoading();var ajaxParams=clientSideData.CALLEE;if(jQuery.trim($("ul.selected li span.outboundDate").text())==""&&typeof clientSideData.CALLEE.B_DATE_1!=="undefined"){ajaxParams["B_DATE_1"]=clientSideData.CALLEE.B_DATE_1;}else{ajaxParams["B_DATE_1"]=jQuery.trim($("ul.selected li span.outboundDate").text());}if(jQuery.trim($("ul.selected li span.inboundDate").text())==""&&typeof clientSideData.CALLEE.B_DATE_2!=="undefined"){ajaxParams["B_DATE_2"]=clientSideData.CALLEE.B_DATE_2;}else{ajaxParams["B_DATE_2"]=jQuery.trim($("ul.selected li span.inboundDate").text());}ajaxParams["MSG_PAGE_CODE"]=clientSideData.MSG_PAGE_CODE;if(!isNaN(parseInt(clientSideData.PAGE_TICKET))){ajaxParams["PAGE_TICKET"]=clientSideData.PAGE_TICKET;}else{ajaxParams["PAGE_TICKET"]="0";}self.updateLowestPricePanelForOWD($(this));var upsellAjaxCallName=clientSideData.IS_REDEMPTION?"rdusplAjax":"usplAjax";var flow=clientSideData.FLOW=="REBOOKING"?"rebooking":"booking";var ajaxUrl=clientSideData.WDS_WEBAPP_URL_RELATIVE+"/dyn/air/"+flow+"/"+upsellAjaxCallName;$("#flightSummaryInterstice").show();$("#flightSummaryArticle").hide();$("#outbound-initDate").text(dateFormat(theUtils.parseDate(ajaxParams["B_DATE_1"]),clientMessages["ALLP.pattern.DateFormat.FullDate"],null,true));$("#inbound-initDate").text(dateFormat(theUtils.parseDate(ajaxParams["B_DATE_2"]),clientMessages["ALLP.pattern.DateFormat.FullDate"],null,true));$("#testStyles").remove();$("#WDS_LOGOUT_FORM input[name='B_DATE_1']").val(ajaxParams.B_DATE_1);$("#WDS_LOGOUT_FORM input[name='B_DATE_2']").val(ajaxParams.B_DATE_2);$.ajax({url:encodeUrl(ajaxUrl),data:ajaxParams,type:"post",dataType:"html",success:function(html){var _html=$(html);if(_html!=null&&_html.attr("id")=="redirectScript"){$("body").append(_html);}var outBoundHtml=_html.find("#upslAjaxOutbound");var inBoundHtml=_html.find("#upslAjaxInbound");var isNoFlightAvailJson=_html.find("#isNoFlightAvail");if(isNoFlightAvailJson.length>0){clientSideData["IS_NO_AVAILABILITY"]=$.parseJSON(jQuery.trim(isNoFlightAvailJson.text()));$("#isNoFlightAvail").remove();}var noAvailErrorMessageJson=_html.find("#noAvailErrorMessage");if(noAvailErrorMessageJson.length>0){clientSideData["NO_AVAIL_ERROR_MESSAGE"]=$.parseJSON(jQuery.trim(noAvailErrorMessageJson.text()));$("#cc").remove();}var upslMatrixJson=_html.find("#odUpslMatrixAjax");if(upslMatrixJson.length>0){clientSideData["OD_UPSL_MATRIX"]=$.parseJSON(jQuery.trim(upslMatrixJson.text()));$("#odUpslMatrix").remove();}var benefitsJson=_html.find("#flightDetailsAjax");if(benefitsJson.length>0){clientSideData["benefitsValues"]=jQuery.parseJSON(jQuery.trim(benefitsJson.text()));$("#flightDetailsAjax").remove();}var outboundFilterRaw=_html.find("#filterDataoutbound");if(outboundFilterRaw.length>0){var filterData=JSON.parse(outboundFilterRaw.html());jQuery.event.trigger("updateFilterData",{"bound":0,"filterData":filterData});$(document).trigger("customFilterComplete",[filterData.numberOfFlights,0]);}var inboundFilterRaw=_html.find("#filterDatainbound");if(inboundFilterRaw.length){var filterData=JSON.parse(inboundFilterRaw.html());jQuery.event.trigger("updateFilterData",{"bound":1,"filterData":JSON.parse(inboundFilterRaw.html())});$(document).trigger("customFilterComplete",[filterData.numberOfFlights,1]);}$("#aside-timetothink-wrapper").remove();var earlyTTTTeaserWrapper=_html.find("#aside-timetothink-wrapper");if(earlyTTTTeaserWrapper.length){$("#aside-price-wrapper").append(earlyTTTTeaserWrapper);}if(clientSideData.IS_NO_AVAILABILITY){if(clientSideData.IS_REDEMPTION){$("#rdCaldButton").trigger("click");}else{$("#seeAllPricesAndDates").trigger("click");}$(".ui-dialog").find(".ui-dialog-titlebar-close").hide();isCaldClickBinded=true;var warning=$("#popinWarning").errorPanel();warning.errorPanel("addError",null,null,clientSideData["NO_AVAIL_ERROR_MESSAGE"][0].TEXT);}else{if(outBoundHtml.length>0){var obInsertAfter=theCoUpslPage.getOutBoundElementToInsertPriceTables();obInsertAfter.after(outBoundHtml.html());}if(inBoundHtml.length>0){var ibInsertAfter=theCoUpslPage.getInBoundElementToInsertPriceTables();ibInsertAfter.after(inBoundHtml.html());}}$(".noBoundTemplateClass").remove();window.flightFilterSearchPage.init();CoUpslPage.prototype.flightDetailsObs={};theCoUpslPage.initPreselectedFlights(manualTrigger);theCoUpslPage.showTooltipForBounds();theCoUpslPage.initSorting();theCoUpslPage.initBoundCollapse();theFlifPage=new FlifPage();clickBlocker=false;$("#flightSummaryInterstice").hide();$("#flightSummaryArticle").show();if(self.queue!=undefined){$(self.queue.target).trigger("click",false);self.queue=undefined;}if(event.originalEvent!==undefined&&$(target).parent().hasClass("inbound")){$(document).trigger("usplAjaxInboundSuccess");}},error:function(XHR,textStatus,errorThrown){$("#flightSummaryInterstice").hide();$("#flightSummaryArticle").show();}});clickBlocker=true;if($(target).parent().hasClass("outbound")){var outboundTabs=$(".calendarPricesSection.outbound ul");if($(".calendarPricesSection.outbound ul.selected")){self.removeSessionCookie("clickedOutboundTab_");self.setSessionCookie("clickedOutboundTab_"+clientSideData.jSessionId,$(".calendarPricesSection.outbound ul.selected").data("date"));}}if($(target).parent().hasClass("inbound")){var inboundTabs=$(".calendarPricesSection.inbound ul");if($(".calendarPricesSection.inbound ul.selected")){self.removeSessionCookie("clickedInboundTab_");self.setSessionCookie("clickedInboundTab_"+clientSideData.jSessionId,$(".calendarPricesSection.inbound ul.selected").data("date"));}}};})());var clickNextUpsl=function(){if(this.id=="timeToThinkSubmitButton"){$("<input type='hidden' id='fromTimeToThinkTeaser' name='fromTimeToThinkTeaser' value='TRUE' />").appendTo($("#ALPI_FORM"));}else{$("#ALPI_FORM").remove("#fromTimeToThinkTeaser");}if(clientSideData.IS_REDEMPTION&&(clientSideData.PROFILE==null||!clientSideData.PROFILE.frequentFlyer)){window.theRdUpslPage.showNotLoggedWarning();}else{if(clientSideData.IS_REDEMPTION&&(clientSideData.PROFILE.frequentFlyerCard.milesBalance<rpModel.totals.grandTotal.points)){$("#pageError").errorPanel("addError",null,null,clientMessages["RD_UPSL.error.NotEnoughMiles"]);$("#pageError").scrollTo();}else{var error=$("#pageError").errorPanel();if($(".inbound").length>0&&$(".inbound td.ff.selectedFF").length!=1){error.errorPanel("addError",null,null,clientMessages[clientSideData.MSG_PAGE_CODE+".error.PleaseSelectInbound"]);$("#pageError").scrollTo();return false;}if($(".outbound").length>0&&$(".outbound td.ff.selectedFF").length!=1){error.errorPanel("addError",null,null,clientMessages[clientSideData.MSG_PAGE_CODE+".error.PleaseSelectOutbound"]);$("#pageError").scrollTo();return false;}fareForm.submit();}}return false;};$("body").delegate("#timeToThinkSubmitButton","click",clickNextUpsl);$("#priceSummaryArticle .main.right, #upslNext, .atcUpslPaxNext").on("click",clickNextUpsl);$(this.mainSection).on("click",".inbound .flight td.ff",function(event,manualTrigger){var myCell=$(this);$(".selectedRowUpsl").removeClass("selectedRowUpsl");if(myCell.hasClass("disabled")){return;}var oldSelection=$(".inbound td.ff.selectedFF");var oldFfIndex=oldSelection.closest("table").parent().find("th").eq(oldSelection.index()).data("ffIndex")+1;var newFfIndex=$(this).closest("table").parent().find("th").eq($(this).index()).data("ffIndex");if(oldSelection.hasClass("lowest")){oldSelection.addClass("em3");}oldSelection.removeClass("selectedFF");oldSelection.removeClass("family"+oldFfIndex);if(myCell.hasClass("lowest")){myCell.removeClass("em3");}self.clickOnTd(myCell);$.jStorage.set("inboundSelectedFF",newFfIndex);$.jStorage.set("inboundPreselected",theUtils.getPreselectedFlight("inbound"));if(event.which&&clientSideData.IS_REDEMPTION&&clientSideData.IS_ROUND_TRIP){self.setSessionCookie("inboundRdFf_"+clientSideData.jSessionId,theUtils.getPreselectedFf("inbound"));self.setSessionCookie("inboundRdFn_"+clientSideData.jSessionId,theUtils.getPreselectedFlightNumber("inbound"));}});$(this.mainSection).on("click",".outbound .flight td.ff",function(event,manualTrigger){var myCell=$(this);$(".selectedRowUpsl").removeClass("selectedRowUpsl");if($(this).hasClass("disabled")){return;}var oldSelection=$(".outbound td.ff.selectedFF");var oldFfIndex=oldSelection.closest("table").parent().find("th").eq(oldSelection.index()).data("ffIndex")+1;var newFfIndex=$(this).closest("table").parent().find("th").eq($(this).index()).data("ffIndex");if(oldSelection.hasClass("lowest")){oldSelection.addClass("em3");}oldSelection.removeClass("selectedFF");oldSelection.removeClass("family"+oldFfIndex);if(myCell.hasClass("lowest")){myCell.removeClass("em3");}self.clickOnTd(myCell);$.jStorage.set("outboundSelectedFF",newFfIndex);$.jStorage.set("outboundPreselected",theUtils.getPreselectedFlight("outbound"));var outboundClicked=self.getSessionCookie("clickedOutboundTab_"+clientSideData.jSessionId);if(event.which&&clientSideData.IS_REDEMPTION){self.setSessionCookie("outboundRdFf_"+clientSideData.jSessionId,theUtils.getPreselectedFf("outbound"));self.setSessionCookie("outboundRdFn_"+clientSideData.jSessionId,theUtils.getPreselectedFlightNumber("outbound"));}});$("#seeAllPricesAndDates").on("click",this.mainSection,function(){var isAtcAndKeepTheFares=clientSideData.IS_ATC==="TRUE"&&clientSideData.TRIP_TYPE==="R"&&typeof clientSideData.ATC_BOUND_NOT_CHANGED!=="undefined";if(isAtcAndKeepTheFares){var id=$("#upslBack").attr("class").split("pb_")[1];id=id.split(" ")[0];var form=$("form#pb_"+id);form.append("<input type='hidden' name='WDS_WARN_KTF_IS_ON_CALENDAR' value='TRUE'/>");$("#upslBack").trigger("click");}else{if($("div.upslPopin").length==0){var popin=undefined;var days=[];for(var i=1;i<=7;i++){days[days.length]=clientMessages["ALLP.listelem.3LettersDay."+i];}var info="";if(clientSideData.SO_SITE_FD_DISPLAY_MODE=="0"){info=clientMessages[clientSideData.MSG_PAGE_CODE+".text.PriceIncludingTaxes"];}else{info=clientMessages[clientSideData.MSG_PAGE_CODE+".text.PriceExcludingTaxes"];}var calendarMessages={changePricesDates:clientMessages["ALLP.text.ChangeDates"],changeDates:clientMessages["ALLP.text.ChangeDates"],info:info,from:clientMessages[clientSideData.CALD_PAGE_CODE+".text.From"],to:clientMessages[clientSideData.CALD_PAGE_CODE+".text.To"],outOfRange:clientMessages[clientSideData.CALD_PAGE_CODE+".text.Legend.OutOfRange"],notAvailable:clientMessages[clientSideData.CALD_PAGE_CODE+".text.Legend.NoSeatReco"],nextBtn:clientMessages[clientSideData.CALD_PAGE_CODE+".text.Next"],daysOfTheWeek:days};var chosenBound;var chosenBoundId;if($("table.bound").eq(0).hasClass("inbound")){chosenBound=clientSideData.CALENDAR.POPIN_INBOUND;chosenBoundId=1;}else{chosenBound=clientSideData.CALENDAR.POPIN_OUTBOUND;chosenBoundId=0;}var outbound=self.prepareSubConfigForCalendar(chosenBound,chosenBoundId,calendarMessages);if(clientSideData.IS_ROUND_TRIP){var inbound=self.prepareSubConfigForCalendar(clientSideData.CALENDAR.POPIN_INBOUND,1,calendarMessages);}var config=[];config[config.length]={messages:calendarMessages,calendar:[$(tamUtils.getElementForTmpls(template_changePricesAndDatesMain.tmpl(outbound))).html()]};if(typeof inbound!=="undefined"){config[0].calendar[1]=$(tamUtils.getElementForTmpls(template_changePricesAndDatesMain.tmpl(inbound))).html();}popin=$(tamUtils.getElementForTmpls(template_changePricesAndDates.tmpl(config)));template_changePricesAndDates.listen(popin);popin.dialog({autoOpen:true,draggable:false,width:800,modal:true,resizable:false,closeOnEscape:false,dialogClass:"upslPopin"});if(clientSideData.IS_ROUND_TRIP){template_changePricesAndDates.listenForInternationalRound(popin);}else{if(clientSideData.IS_ATC=="TRUE"){template_changePricesAndDates.listenForOneWayRebookingFee(popin);}}return false;}else{$(".ui-dialog-content",$("div.upslPopin")).dialog("open");}}});};CoUpslPage.prototype.prepareSubConfigForCalendar=function(listOfDays,boundNr,calendarMessages){response=[];var messages=jQuery.extend(true,{},calendarMessages);var emptyRow=true;var daysInWeek=7;for(var i=1;i<=listOfDays.length/3;i++){emptyRow=emptyRow&&listOfDays[i-1].OUT_OF_SCOPE;if(i%daysInWeek==0&&emptyRow){listOfDays=listOfDays.slice(i,listOfDays.length);}}var boundId;if(boundNr==0){messages.inboundOutbound=clientMessages[clientSideData.PAGE_CODE+".text.Departure"];boundId="outbound";messages.initDate=$("#outbound-initDate").text();}else{messages.inboundOutbound=clientMessages[clientSideData.PAGE_CODE+".text.Inbound"];boundId="inbound";messages.initDate=$("#inbound-initDate").text();}response[response.length]={"bound":boundId,"days":listOfDays,"departureCity":{"cityCode":clientSideData.DEPARTURE[boundNr].CITY_CODE,"locationCode":clientSideData.DEPARTURE[boundNr].LOCATION_CODE,"cityName":clientSideData.DEPARTURE[boundNr].CITY_NAME},"arrivalCity":{"cityCode":clientSideData.ARRIVAL[boundNr].CITY_CODE,"locationCode":clientSideData.ARRIVAL[boundNr].LOCATION_CODE,"cityName":clientSideData.ARRIVAL[boundNr].CITY_NAME},"messages":messages};return response;};CoUpslPage.prototype.submit=function(){return false;};CoUpslPage.prototype.coCaldDatepicker=(function(){var createDate=function(str){return new Date(str.substr(0,4),(~~(str.substr(4,2))-1),str.substr(6,2));};var checkDatesCondition=function(date){if($("#ui-datepicker-div-1").length>0){var selectFrom;_caldDatePickers.each(function(index){if($(this).val()==date){selectFrom=index;}});var date0=createDate(_caldDatePickers.eq(0).val());var date1=createDate(_caldDatePickers.eq(1).val());if(date0>date1){if(selectFrom==0){_caldDatePickers.eq(1).datepicker("setDate",date0);}else{_caldDatePickers.eq(0).datepicker("setDate",date1);}}}};var deleteToMuchButtons=function(){if($("#ui-datepicker-div-1").length>0){$("#ui-datepicker-div-1 .closeDatePickerBtn").remove();$("#ui-datepicker-div-0 .changeDatePickerBtn").remove();}};var insertButtons=function(content){var elem=$(tamUtils.getElementForTmpls("<div>"+content+"</div>"));var buttons=elem.find(".ui-datepicker-buttonpane");var buttonClose=$("<button id='closeDatePickerBtn' class='closeDatePickerBtn ui-state-default' style='float:left'>"+clientMessages["ALLP.text.close"]+"</close>");var buttonChange=$("<button id='changeDatePickerBtn' class='changeDatePickerBtn ui-state-default' style='float:right'>"+clientMessages["ALLP.text.done"]+"</close>");buttons.html("").append(buttonClose).append(buttonChange);return elem.html();};var getMaxDate=function(){if(clientSideData.PAGE_CODE!="undefined"&&clientSideData.MSG_PAGE_CODE!="undefined"){if(clientSideData.MSG_PAGE_CODE=="CO_UPSL"||clientSideData.MSG_PAGE_CODE=="OD_UPSL"){return clientSideData["WDS_MAX_DATE_REVENUE"];}if(clientSideData.MSG_PAGE_CODE=="RD_UPSL"){if(clientSideData.IS_INTERNATIONAL=="true"){return clientSideData["WDS_MAX_DATE_REDEMPTION_INT"];}else{return clientSideData["WDS_MAX_DATE_REDEMPTION_DOM"];}}}return clientSideData["WDS_MAX_DATE_REVENUE"];};var config=$.extend({},tamUtils.defaultDatePickerConfigurationObject,{numberOfMonths:2,showAnim:"",dateFormat:"yymmdd",showButtonPanel:true,minDate:"0",maxDate:"+"+getMaxDate()+"D",firstDay:clientSideData.WEEK_STARTS_ON_SUNDAY?0:1,onSelect:function(date){$(this).data("datepicker").inline=true;$.datepicker.dateCald=date;checkDatesCondition(date);},onClose:function(){$(this).data("datepicker").inline=false;},beforeShow:function(input,inst){$("img.ui-datepicker-trigger").hide();}});var increaseOverlay=function(){var overlay=$(".ui-widget-overlay");overlay.css("z-index",(~~overlay.css("z-index"))+3).css("background","gray");};var decreaseOverlay=function(){var overlay=$(".ui-widget-overlay");overlay.css("z-index",(~~overlay.css("z-index"))-3);};var getOverlayZIndex=function(){var overlay=$(".ui-widget-overlay");return(~~overlay.css("z-index"));};$("body").on("click","#closeDatePickerBtn",function(){decreaseOverlay();_caldDatePickers.each(function(index){var id="ui-datepicker-div-"+index;$("#"+id).hide();_hide=true;});});$("body").on("click","#changeDatePickerBtn",function(){var request=clientSideData.CALLEE;var redirect=false;_caldDatePickers.each(function(index){if(typeof $(this).val()!=="undefined"&&jQuery.trim($(this).val())!=""){redirect=true;request["B_DATE_"+(index+1)]=jQuery.trim($(this).val())+"0000";}});request["REFRESH"]=0;if(redirect){request["WDS_OPEN_CALD"]="TRUE";var fullLocation=""+window.location;var controller;if(clientSideData.IS_ATC){controller="rebooking/";if(fullLocation.indexOf("rebooking")>0){controller="";}}else{controller="booking/";if(fullLocation.indexOf("booking")>0){controller="";}}if(clientSideData.IS_REDEMPTION){if(clientSideData.IS_FULL_POINTS_SITE){tamUtils.goPost(encodeUrl("availability"),request);}else{tamUtils.goPost(encodeUrl(controller+"redemptionAvailability"),request);}}else{if(clientSideData.IS_ATC){tamUtils.goPost(encodeUrl(controller+"availability"),request);}else{tamUtils.goPost(encodeUrl(controller+"coUpsl"),request);}}}else{$("#closeDatePickerBtn").trigger("click");}});var _hide=false;var _firstInvocation=true;var _caldDatePickers;return function(triggerElem,popin){increaseOverlay();if(_hide){_caldDatePickers.each(function(index){var id="ui-datepicker-div-"+index;var oldStyle=$("#"+id).get(0).style.cssText;if(oldStyle.charAt(oldStyle.length-1)!=";"){oldStyle+=";";}var currentStyle=oldStyle+"z-index: "+(getOverlayZIndex()+1)+" !important";$("#"+id).css("cssText",currentStyle).show();});_hide=false;}else{if(_firstInvocation){(function($){var origGenerateHtml=$.datepicker._generateHTML;$.datepicker._generateHTML=function(){var html=origGenerateHtml.apply(this,arguments);html=insertButtons(html);return html;};var origUpdateDatepicker=$.datepicker._updateDatepicker;$.datepicker._updateDatepicker=function(){origUpdateDatepicker.apply(this,arguments);deleteToMuchButtons();};$.datepicker._getDate=function(){return $.datepicker.dateCald;};})($);_firstInvocation=false;}_caldDatePickers=triggerElem;var datePickers=[];triggerElem.each(function(index){var id="ui-datepicker-div-"+index;$.datepicker._mainDivId=id;$.datepicker.dpDiv.attr("id",id);if(typeof $(this).data("coCaldDatepicker")==="undefined"){var bDate=clientSideData.ORGINAL_B_DATE_1;if(index==1){bDate=clientSideData.ORGINAL_B_DATE_2;}var bDatepick=new Date(bDate.substring(0,4)+"/"+bDate.substring(4,6)+"/"+bDate.substring(6,8));$(this).datepicker(config).data("coCaldDatepicker",true);var datePicker=$(this);$(this).datepicker("setDate","20121214");$(this).datepicker("setDate",bDatepick);}if(!$("#ui-datepicker-div").is(":visible")){$(this).datepicker("show");}datePickers[datePickers.length]=$("#"+id).clone(true);$("#"+id).attr("id","");$(this).datepicker("hide");var obC=$(this).data("datepicker");obC.dpDiv=datePickers[datePickers.length-1];$(this).data("datepicker",obC);});for(key in datePickers){if(typeof datePickers[key]!="function"){$("body").append(datePickers[key]);}}deleteToMuchButtons();var topOffset=75;var popinUiDialog=popin.closest(".ui-dialog");if(datePickers.length>1){for(key in datePickers){if(typeof datePickers[key]!="function"){if(clientSideData.IS_REDEMPTION){var datePickerOffset=-28;}else{var datePickerOffset=68;}var popinWidth=~~popinUiDialog.css("left").replace("px","")-datePickerOffset+(key*461);var popinTop=~~popinUiDialog.css("top").replace("px","")+topOffset;datePickers[key].css("left",popinWidth+"px").css("top",popinTop+"px").css("display","block").css("position","absolute");var currentStyle=datePickers[key].get(0).style.cssText+";z-index: "+(getOverlayZIndex()+1)+" !important";datePickers[key].css("cssText",currentStyle);$("#ui-datepicker-div-"+key).css("left",(popinWidth+10)+"px");}}}else{if(clientSideData.IS_REDEMPTION){var datePickerOffset=-10;}else{var datePickerOffset=150;}var popinWidth=~~popinUiDialog.css("left").replace("px","")+datePickerOffset;var popinTop=~~popinUiDialog.css("top").replace("px","")+topOffset;$("#ui-datepicker-div-0").css("left",popinWidth+"px").css("top",popinTop+"px").css("position","absolute");var currentStyle=$("#ui-datepicker-div-0").get(0).style.cssText+";z-index: "+(getOverlayZIndex()+1)+" !important";$("#ui-datepicker-div-0").css("cssText",currentStyle);}}};})();function FilterPanel(){$("#mainOuter select").selectBox();this.filterData=null;this.bound=null;this.nbBounds=null;this.currencyCode=clientSideData.CURRENCIES_MAP[clientSideData.CURRENCY_CODE];this.formattingFunctionToUse;if(!clientSideData.IS_REDEMPTION){formattingFunctionToUse=theUtils.formatPrice;this.currencyCode=clientSideData.CURRENCIES_MAP[clientSideData.CURRENCY_CODE];if(clientSideData.CURRENCY_CODE=="ARS"){this.currencyCode="";}}else{formattingFunctionToUse=theUtils.formatPoints;this.currencyCode="";}this.showHideFilter();this.listen();this.init();this.listenTriggersEvents();}FilterPanel.prototype.init=function(){var self=this;self.nbBounds=clientSideData.FILTER_DATA.length;for(var i=0;i<self.nbBounds;i++){var eventData={"bound":i,"filterData":clientSideData.FILTER_DATA[i]};$.event.trigger("updateFilterData",eventData);}};FilterPanel.prototype.listenTriggersEvents=function(){var self=this;$(document).on("change",".nbstops, .destairports",function(){var boundType=this.id.split("_")[0];self.triggerFlightFilter(boundType);});$(document).on("customFilterComplete",function(event,nbDisplayedRowsAfterFilter,bound){var totalFlights=clientSideData.FILTER_DATA[bound].numberOfFlights;var message=clientMessages["ALLP.text.FilteredNumberFlights"];$("#"+bound+"_filters").find("span.filter-shown-flights").text(message.replace("{0}",nbDisplayedRowsAfterFilter).replace("{1}",totalFlights));if(nbDisplayedRowsAfterFilter==0){$("#"+bound+"_filter-form-reset-remote").attr("style","display: block");}else{$("#"+bound+"_filter-form-reset-remote").attr("style","display: none");}});};FilterPanel.prototype.listen=function(){var self=this;$(document).on("updateFilterData",function(event,params){self.filterData=params.filterData;self.bound=params.bound;var buttonText=clientMessages["ALLP.text.HideFilters"]+'<small class="ico minus-white"></small>';$("[name="+self.bound+"_show-hide-filter-button]").html(buttonText);var message=clientMessages["ALLP.text.FilteredNumberFlights"];$("#"+self.bound+"_filters").find("span.filter-shown-flights").text(message.replace("{0}",self.filterData.numberOfFlights).replace("{1}",self.filterData.numberOfFlights));clientSideData.FILTER_DATA[self.bound].numberOfFlights=self.filterData.numberOfFlights;var stops=[];for(var i=0;i<self.filterData.connections.length;i++){if(self.filterData.connections[i]==0){stops.push({"text":clientMessages["ALLP.text.NonStop"],"code":self.filterData.connections[i]});}else{if(self.filterData.connections[i]==1){stops.push({"text":clientMessages["ALLP.text.OneStop"],"code":self.filterData.connections[i]});}else{stops.push({"text":clientMessages["ALLP.text.TwoPlusStops"],"code":self.filterData.connections[i]});}}}var destinations=[];for(var i=0;i<self.filterData.locations.length;i++){var location=self.filterData.locations[i].split(":");destinations.push({"code":location[1],"name":location[0]});}var templateData={"destinations":destinations,"bound":self.bound,"stops":stops,"ALLP_text_Stops":clientMessages["ALLP.text.Stops"],"ALLP_text_Price":clientSideData.IS_REDEMPTION?clientMessages["ALLP.text.Points"]:clientMessages["ALLP.text.Price"],"ALLP_text_Duration":clientMessages["ALLP.text.Duration"],"ALLP_text_Departure":clientMessages["ALLP.text.Departure"],"ALLP_text_Arrival":clientMessages["ALLP.text.Arrival"],"ALLP_text_To":clientMessages["ALLP.text.To"],"ALLP_text_DestinationAirports":clientMessages["ALLP.text.DestinationAirports"]};var filterTemplate=$(tamUtils.getElementForTmpls($("#views_air_booking_panels_upsl_upslFilterTemplate").tmpl(templateData)));$("#"+self.bound+"_section").remove();if((self.filterData.numberOfFlights<=1)||(self.filterData.minPrice===self.filterData.maxPrice&&self.filterData.minDuration===self.filterData.maxDuration&&self.filterData.departureStartDate===self.filterData.departureEndDate&&self.filterData.arrivalStartDate===self.filterData.arrivalEndDate&&self.filterData.connections.length<2&&self.filterData.locations.length<2)){$("[name="+self.bound+"_show-hide-filter-button]").hide();$("[id="+self.bound+"_reset-filter-button]").hide();$("[name="+self.bound+"_show-hide-filter-button]").trigger("click");}else{$("[name="+self.bound+"_show-hide-filter-button]").show();$("[id="+self.bound+"_reset-filter-button]").show();$("#"+self.bound+"_filters").after(filterTemplate);}self.initFilterSliders();setInitialsliderValues(self.bound);});function setInitialsliderValues(bounds){for(var i=0;i<bounds;i++){var boundType=i;var slider=$("#"+boundType+"_slider-range-price");slider.slider("values",0,slider.slider("option","min"));slider.slider("values",1,slider.slider("option","max"));slider=$("#"+boundType+"_slider-range-departure");slider.slider("values",0,slider.slider("option","min"));slider.slider("values",1,slider.slider("option","max"));slider=$("#"+boundType+"_slider-range-arrival");slider.slider("values",0,slider.slider("option","min"));slider.slider("values",1,slider.slider("option","max"));slider=$("#"+boundType+"_slider-range-duration");slider.slider("value",slider.slider("option","max"));}}$("[name$=_show-hide-filter-button]").on("click",function(){var boundType=this.name.split("_")[0];var showFilters=clientMessages["ALLP.text.ShowFilters"];var hideFilters=clientMessages["ALLP.text.HideFilters"];var buttonText=$("#"+boundType+"_section").is(":visible")?showFilters+'<small class="ico plus-white"></small>':hideFilters+'<small class="ico minus-white"></small>';$("[name="+boundType+"_show-hide-filter-button]").html(buttonText);$("#"+boundType+"_section").slideToggle();});$(document).on("click","[id$=_reset-filter-button], [id$=_reset_filter_link]",function(event){event.preventDefault();var boundType=this.id.split("_")[0];var slider=$("#"+boundType+"_slider-range-price");slider.slider("values",0,slider.slider("option","min"));slider.slider("values",1,slider.slider("option","max"));$("#"+boundType+"_priceMinSelected").text(self.currencyCode+" "+formattingFunctionToUse(slider.slider("option","min")));$("#"+boundType+"_priceMaxSelected").text(self.currencyCode+" "+formattingFunctionToUse(slider.slider("option","max")));slider=$("#"+boundType+"_slider-range-departure");slider.slider("values",0,slider.slider("option","min"));slider.slider("values",1,slider.slider("option","max"));$("#"+boundType+"_departure_days_1").empty();self.slideTime(undefined,$("#"+boundType+"_slider-range-departure"),$("#"+boundType+"_departureStartTimeSelected"),$("#"+boundType+"_departureEndTimeSelected"),$("#"+boundType+"_departure_days_1"),$("#"+boundType+"_departure_days_2"),$("#"+boundType+"_slider-range-departure"));slider=$("#"+boundType+"_slider-range-arrival");slider.slider("values",0,slider.slider("option","min"));slider.slider("values",1,slider.slider("option","max"));$("#"+boundType+"_arrival_days_1").empty();self.slideTime(undefined,$("#"+boundType+"_slider-range-arrival"),$("#"+boundType+"_arrivalStartTimeSelected"),$("#"+boundType+"_arrivalEndTimeSelected"),$("#"+boundType+"_arrival_days_1"),$("#"+boundType+"_arrival_days_2"),$("#"+boundType+"_slider-range-departure"));slider=$("#"+boundType+"_slider-range-duration");slider.slider("value",slider.slider("option","max"));var initial_max=slider.slider("option","max");var minutes1=parseInt((initial_max/60000)%60,10),hours1=parseInt((initial_max/60000)/60,10);minutes1=minutes1>9?minutes1:"0"+minutes1;$("#"+boundType+"_durationMaxSelected").text(hours1+"h"+minutes1+"m");$("#"+boundType+"_section").find($("input:checkbox.destairports")).each(function(){this.checked=true;});$("#"+boundType+"_section").find($("input:checkbox.nbstops")).each(function(){this.checked=true;});self.triggerFlightFilter(boundType);});$("[id$=_sorting]").on("change",function(){var boundType=this.id.split("_")[0];var val=$(this).val();var bound=boundType==0?"outbound":"inbound";var table=$("#"+bound+"_list_flight");var ff=$.jStorage.get(bound+"SelectedFF");if(val=="Price"){var td=$(table).find("th[data-ff-index='"+ff+"']");var th=$(table).find(td);$(th).click();}else{if(val=="Duration"){$(table).find("thead th.durationTh").click();}else{if(val=="Departure"){$(table).find("thead th.fromTh").click();}else{if(val=="Arrival"){$(table).find("thead th.toTh").click();}else{if(val=="Default"){var td=$(table).find("thead th.rjsTh");var sorting;var x=clientSideData.LIST_FF.length+4;sorting=[[x,0]];$(td).trigger("sorton",[sorting]);}}}}}});};FilterPanel.prototype.initFilterSliders=function(){var self=this;$("[id$=_slider-range-price]").slider({range:true,values:[0,0],create:function(event,ui){var boundType=self.bound;$(this).slider("option","step",self.filterData.priceStep);$(this).slider("option","min",self.filterData.minPrice);$(this).slider("option","max",self.filterData.maxPrice);$(this).slider("values",0,self.filterData.minPrice);$(this).slider("values",1,self.filterData.maxPrice);$("#"+boundType+"_priceMinSelected").text(self.currencyCode+" "+formattingFunctionToUse($(this).slider("option","min")));$("#"+boundType+"_priceMaxSelected").text(self.currencyCode+" "+formattingFunctionToUse($(this).slider("option","max")));if(self.filterData.minPrice===self.filterData.maxPrice){$("#"+boundType+"_section").find(".slider-price").find(".filter-header").hide();$("#"+boundType+"_section").find("#"+boundType+"_slider-range-price").hide();$("#"+boundType+"_section").find(".slider-price").find(".filter-input-wrapper").hide();}},slide:function(event,ui){var boundType=this.id.split("_")[0];if(ui.values[1]>$(this).slider("option","max")){ui.values[1]=$(this).slider("option","max");}$("#"+boundType+"_priceMinSelected").text(self.currencyCode+" "+formattingFunctionToUse(ui.values[0]));$("#"+boundType+"_priceMaxSelected").text(self.currencyCode+" "+formattingFunctionToUse(ui.values[1]));},stop:function(event,ui){var boundType=this.id.split("_")[0];self.triggerFlightFilter(boundType);}});$("[id$=_slider-range-duration]").slider({range:"min",value:0,create:function(event,ui){var boundType=self.bound;$(this).slider("option","step",self.filterData.durationStep);$(this).slider("option","min",self.filterData.minDuration);$(this).slider("option","max",self.filterData.maxDuration);$(this).slider("value",self.filterData.maxDuration);var initial_min=$(this).slider("option","min");var initial_max=$(this).slider("option","max");var minutes0=parseInt((initial_min/60000)%60,10),hours0=parseInt((initial_min/60000)/60,10),minutes1=parseInt((initial_max/60000)%60,10),hours1=parseInt((initial_max/60000)/60,10);minutes0=minutes0>9?minutes0:"0"+minutes0;minutes1=minutes1>9?minutes1:"0"+minutes1;$("#"+boundType+"_durationMinSelected").text(hours0+"h"+minutes0+"m");$("#"+boundType+"_durationMaxSelected").text(hours1+"h"+minutes1+"m");if(self.filterData.minDuration===self.filterData.maxDuration){$("#"+boundType+"_section").find(".slider-duration").hide();}},slide:function(event,ui){var boundType=this.id.split("_")[0];if(ui.value>$(this).slider("option","max")){ui.value=$(this).slider("option","max");}var minutes0=parseInt((ui.value/60000)%60,10),hours0=parseInt((ui.value/60000)/60,10);minutes0=minutes0>9?minutes0:"0"+minutes0;$("#"+boundType+"_durationMaxSelected").text(hours0+"h"+minutes0+"m");},stop:function(event,ui){var boundType=this.id.split("_")[0];self.triggerFlightFilter(boundType);}});$("[id$=_slider-range-departure]").slider({range:true,values:[0,0],create:function(event,ui){var boundType=self.bound;$(this).slider("option","step",self.filterData.departureStep);$(this).slider("option","min",self.filterData.departureStartDate);$(this).slider("option","max",self.filterData.departureEndDate);$(this).slider("values",0,self.filterData.departureStartDate);$(this).slider("values",1,self.filterData.departureEndDate);self.slideTime(undefined,$(this),$("#"+boundType+"_departureStartTimeSelected"),$("#"+boundType+"_departureEndTimeSelected"),$("#"+boundType+"_departure_days_1"),$("#"+boundType+"_departure_days_2"),$("#"+boundType+"_slider-range-departure"));if(self.filterData.departureStartDate===self.filterData.departureEndDate){$("#"+boundType+"_section").find(".slider-departure").hide();}},slide:function test(event,ui){var boundType=this.id.split("_")[0];var id1=$("#"+boundType+"_departureStartTimeSelected"),id2=$("#"+boundType+"_departureEndTimeSelected"),id3=$("#"+boundType+"_departure_days_1"),id4=$("#"+boundType+"_departure_days_2"),id5=$("#"+boundType+"_slider-range-departure"),sliderId=$(this);self.slideTime(ui,sliderId,id1,id2,id3,id4,id5);},stop:function(event,ui){var boundType=this.id.split("_")[0];self.triggerFlightFilter(boundType);}});$("[id$=_slider-range-arrival]").slider({range:true,values:[0,0],create:function(event,ui){var boundType=self.bound;$(this).slider("option","step",self.filterData.arrivalStep);$(this).slider("option","min",self.filterData.arrivalStartDate);$(this).slider("option","max",self.filterData.arrivalEndDate);$(this).slider("values",0,self.filterData.arrivalStartDate);$(this).slider("values",1,self.filterData.arrivalEndDate);self.slideTime(undefined,$(this),$("#"+boundType+"_arrivalStartTimeSelected"),$("#"+boundType+"_arrivalEndTimeSelected"),$("#"+boundType+"_arrival_days_1"),$("#"+boundType+"_arrival_days_2"),$("#"+boundType+"_slider-range-departure"));if(self.filterData.arrivalStartDate===self.filterData.arrivalEndDate){$("#"+boundType+"_section").find(".slider-arrival").hide();}},slide:function test(event,ui){var boundType=this.id.split("_")[0];var id1=$("#"+boundType+"_arrivalStartTimeSelected"),id2=$("#"+boundType+"_arrivalEndTimeSelected"),id3=$("#"+boundType+"_arrival_days_1"),id4=$("#"+boundType+"_arrival_days_2"),id5=$("#"+boundType+"_slider-range-departure"),sliderId=$(this);self.slideTime(ui,sliderId,id1,id2,id3,id4,id5);},stop:function(event,ui){var boundType=this.id.split("_")[0];self.triggerFlightFilter(boundType);}});};FilterPanel.prototype.triggerFlightFilter=function(boundType){var sliderPrice=$("#"+boundType+"_slider-range-price");var sliderArrival=$("#"+boundType+"_slider-range-arrival");var sliderDeparture=$("#"+boundType+"_slider-range-departure");var sliderDuration=$("#"+boundType+"_slider-range-duration");var destinations=[];$("#"+boundType+"_section").find($("input:checkbox.destairports")).each(function(){if(!this.checked){destinations.push($(this).data("code"));}});var stops=[];$("#"+boundType+"_section").find($("input:checkbox.nbstops")).each(function(){if(!this.checked){stops.push($(this).data("code"));}});var data={"price":sliderPrice.slider("option","values"),"duration":sliderDuration.slider("option","value"),"arrival":sliderArrival.slider("option","values"),"departure":sliderDeparture.slider("option","values"),"stops":stops,"destinations":destinations};$(document).trigger("customFlightsFilter",[boundType,data]);};FilterPanel.prototype.slideTime=function(ui,sliderId,id1,id2,id3,id4,id5){var val0=ui?ui.values[0]:sliderId.slider("values",0),val1=ui?ui.values[1]:sliderId.slider("values",1);if(val1>sliderId.slider("option","max")){val1=sliderId.slider("option","max");}var date1=theUtils.getUtcDate(val0),date2=theUtils.getUtcDate(val1),dateDeparture=theUtils.getUtcDate(id5.slider("option","min")),minutes0=date1.getMinutes(),hours0=date1.getHours(),minutes1=date2.getMinutes(),hours1=date2.getHours(),dateDifference1=getDaysDiff(dateDeparture,date1),dateDifference2=getDaysDiff(dateDeparture,date2);if(dateDifference1>0){id3.text("+"+dateDifference1);}else{id3.empty();}if(dateDifference2>0){id4.text("+"+dateDifference2);}else{id4.empty();}minutes0=minutes0>9?minutes0:"0"+minutes0;minutes1=minutes1>9?minutes1:"0"+minutes1;id1.text(hours0+":"+minutes0);id2.text(hours1+":"+minutes1);function getDaysDiff(date1,date2){if(date1.getMonth()==date2.getMonth()){return date2.getDate()-date1.getDate();}else{var numOfDaysInMonth=new Date(date1.getYear(),date1.getMonth(),0).getDate();return date2.getDate()+(numOfDaysInMonth-date1.getDate());}}function getTime(hours,minutes){var time=null;minutes=minutes+"";if(hours<12){time="AM";}else{time="PM";}if(hours==0){hours=12;}if(hours>12){hours=hours-12;}if(minutes.length==1){minutes="0"+minutes;}return hours+":"+minutes+" "+time;}};FilterPanel.prototype.showHideFilter=function(){for(var i=0;i<clientSideData.FILTER_DATA.length;i++){var filterData=clientSideData.FILTER_DATA[i];if(filterData.numberOfFlights<=1||(filterData.minPrice===filterData.maxPrice&&filterData.minDuration===filterData.maxDuration&&filterData.departureStartDate===filterData.departureEndDate&&filterData.arrivalStartDate===filterData.arrivalEndDate&&filterData.connections.length<2&&filterData.locations.length<2)){$("[name="+i+"_show-hide-filter-button]").hide();$("[id="+i+"_reset-filter-button], [id="+i+"_reset_filter_link]").hide();$("[name="+i+"_show-hide-filter-button]").trigger("click");}else{$("[name="+i+"_show-hide-filter-button]").show();$("[id="+i+"_reset-filter-button], [id="+i+"_reset_filter_link]").show();}}};$(function(){window.theCoUpslPage=new CoUpslPage();theCoUpslPage.handlePreselctedTabs();window.theFilterPanel=new FilterPanel();});