function RemarketingManager(){}RemarketingManager.prototype.addAlpiRemarketingData=function(){var remarketingDataSerialysedInJson=this.buildRemarketingData("ALPI",this.buildPassengerData(false));$("<input>").attr("type","hidden").attr("name","REMARKETING_DATA").attr("value",remarketingDataSerialysedInJson).appendTo($("#MAIN_ALPI_FORM"));};RemarketingManager.prototype.buildRemarketingData=function(pageCode,remarketingData){var remarketingDataForJson={bookingFlow:clientSideData.REMARKETING.REMARKETING_BOOKING_FLOW,pageCode:pageCode,sessionId:clientSideData.jSessionId,data:remarketingData};var remarketingDataSerialysedInJson=JSON.stringify(remarketingDataForJson);return remarketingDataSerialysedInJson;};RemarketingManager.prototype.addExactTargetRemarketingData=function(remarketingData){if(clientSideData.REMARKETING.REMARKETING_DEEP_LINK_INFO!=null&&clientSideData.REMARKETING.REMARKETING_DEEP_LINK_INFO!=undefined){remarketingData["jobID"]=clientSideData.REMARKETING.REMARKETING_DEEP_LINK_INFO.EXACT_TARGET_JOB_ID;remarketingData["subscriberID"]=clientSideData.REMARKETING.REMARKETING_DEEP_LINK_INFO.EXACT_TARGET_SUBSCRIBER_ID;}};RemarketingManager.prototype.sendAlpiOnAbandonData=function(){var remarketingDataSerialysedInJson=JSON.stringify(this.buildPassengerData(true));var parameters={"BOOKING_FLOW":clientSideData.REMARKETING.REMARKETING_BOOKING_FLOW,"WDS_MARKET":clientSideData.WDS_MARKET,"PAGE_CODE":"ALPI","ID":clientSideData.jSessionId,"TAM_ET_GET":remarketingDataSerialysedInJson,"SITE":clientSideData.SITE,"LANGUAGE":clientSideData.LANGUAGE};$.ajax({async:false,type:"GET",url:encodeUrl("/TAM/dyn/air/booking/exactTargetAbandonCall"),data:parameters});};RemarketingManager.prototype.buildPassengerData=function(callTypeAbandon){var self=this;var alpiRemarketing=clientSideData["REMARKETING_ALPI"];alpiRemarketing["pageAbandon"]=callTypeAbandon;var passengerCount=0;var alpiPage=$("#MAIN_ALPI_FORM");for(var i=1;i<=clientSideData.REMARKETING.NUMBER_OF_ADT_AND_CHD;i++){var tmplPassengerData={};var fname=alpiPage.find("input[name='FIRST_NAME_"+i+"']");if(fname!=null&&fname.val()!=""){tmplPassengerData["firstName"]=fname.val();}var lname=alpiPage.find("input[name='LAST_NAME_"+i+"']");if(lname!=null&&lname.val()!=""){tmplPassengerData["lastName"]=lname.val();}var mname=alpiPage.find("input[name='MIDDLE_NAME_"+i+"']");if(mname!=null&&mname.val()!=""){tmplPassengerData["middleName"]=mname.val();}var title=alpiPage.find("select[name='TITLE_"+i+"']");if(title!=null&&title.val()!=""){tmplPassengerData["title"]=title.val();}var dob=self.getDateOfBirth(alpiPage,i,false);if(dob!=null&&!isNaN(dob)){tmplPassengerData["dateOfBirth"]=dob;}var ttype=alpiPage.find("input[name='TRAVELLER_TYPE_"+i+"']");if(ttype!=null&&ttype.val()!=""){tmplPassengerData["type"]=ttype.val();}var ffnumber=alpiPage.find("input[name='PREF_AIR_FREQ_NUMBER_"+i+"']");if(ffnumber!=null&&ffnumber.val()!=""){tmplPassengerData["ffNumber"]=ffnumber.val();}var ffprogram=alpiPage.find("select[name='PREF_AIR_FREQ_AIRLINE_"+i+"'] option:selected").text();if(ffprogram!=null&&ffprogram!=""&&ffprogram!="Select program"){tmplPassengerData["ffProgram"]=ffprogram;}if(i==1){var email=alpiPage.find("input[name='CONTACT_POINT_EMAIL_1']");if(email!=null&&email.val()!=""){var noRemarketingPrefix="";if($("#opt-out-of-remarketing").length>0&&!$("#opt-out-of-remarketing").attr("checked")){noRemarketingPrefix="[NO-REMARKETING]";}tmplPassengerData["email"]=noRemarketingPrefix+email.val();}var phnumber=alpiPage.find("input[name='CONTACT_POINT_MOBILE_NUMBER_1']");if(phnumber!=null&&phnumber.val()!=""){tmplPassengerData["phoneNumber"]=phnumber.val();}var phtype=alpiPage.find("select[name='CONTACT_POINT_MOBILE_TYPE_1']");if(phtype!=null&&phtype.val()!=""){tmplPassengerData["phoneType"]=phtype.val();}}alpiRemarketing["passenger"][passengerCount]=tmplPassengerData;passengerCount++;}for(var i=1;i<=clientSideData.REMARKETING.NUMBER_OF_INF;i++){var tmplPassengerData={};var fname=alpiPage.find("input[name='INFANT_FIRST_NAME_"+i+"']");if(fname!=null&&fname.val()!=""){tmplPassengerData["firstName"]=fname.val();}var lname=alpiPage.find("input[name='INFANT_LAST_NAME_"+i+"']");if(lname!=null&&lname.val()!=""){tmplPassengerData["lastName"]=lname.val();}var mname=alpiPage.find("input[name='INFANT_MIDDLE_NAME_"+i+"']");if(mname!=null&&mname.val()!=""){tmplPassengerData["middleName"]=mname.val();}var dob=self.getDateOfBirth(alpiPage,i,true);if(dob!=null&&!isNaN(dob)){tmplPassengerData["dateOfBirth"]=dob;}tmplPassengerData["type"]="INF";alpiRemarketing["passenger"][passengerCount]=tmplPassengerData;passengerCount++;}this.addExactTargetRemarketingData(alpiRemarketing);return alpiRemarketing;};RemarketingManager.prototype.getDateOfBirth=function(alpiForm,passengerId,isInfant){var infantPrefix="";if(isInfant){infantPrefix="INFANT_";}var dayField=alpiForm.find("#"+infantPrefix+"DATE_OF_BIRTH_DAY_"+passengerId);var monthField=alpiForm.find("#"+infantPrefix+"DATE_OF_BIRTH_MONTH_"+passengerId);var yearField=alpiForm.find("#"+infantPrefix+"DATE_OF_BIRTH_YEAR_"+passengerId);if(dayField.length!=0&&monthField.length!=0&&yearField.length!=0){var day=dayField.val();var month=monthField.val();var year=yearField.val();if(day!=null&&month!=null&&year!=null){return Math.round(new Date(parseInt(year,10),parseInt(month,10)-1,parseInt(day,10)).getTime()/1000);}}return null;};RemarketingManager.prototype.callExactTargetIfRequested=function(){if(clientSideData["remarketingData"]!=null){this.callExactTarget(JSON.parse(clientSideData["remarketingData"].replace(/&quot;/g,'"')));}};RemarketingManager.prototype.callExactTarget=function(remarketingData){var parameters={"BOOKING_FLOW":remarketingData.bookingFlow,"WDS_MARKET":clientSideData.WDS_MARKET,"PAGE_CODE":remarketingData.pageCode,"ID":remarketingData.sessionId,"TAM_ET_GET":JSON.stringify(remarketingData.data)};tamUtils.goPostAsync(clientSideData.REMARKETING.REMARKETING_URL,parameters);};RemarketingManager.prototype.addFsrRemarketingData=function(){var remarketingDataSerialysedInJson=this.buildRemarketingData("FSR",this.buildFSRData());$("<input>").attr("type","hidden").attr("name","REMARKETING_DATA").attr("value",remarketingDataSerialysedInJson).appendTo($("#FSR_FORM"));};RemarketingManager.prototype.buildFSRData=function(){var fsrDataStructure={totalExtraBags:0,totalExtraBagsType:"pieces",totalChargeableSeats:0,flights:[]};var exBagIsPiecesOutBound=true;var exBagIsPiecesInBound=true;var totalQuantityData={xBagTotalQuantity:0,seatTotalQuantity:0,exBagIsPieces:true,ancillaryTotal:0};fsrDataStructure["flights"][0]=this.buildFSRFlightData(1,clientSideData.REMARKETING_FSR.OUTBOUND_SEGMENT_SIZE,totalQuantityData,1);exBagIsPiecesOutBound=totalQuantityData["exBagIsPieces"];if(clientSideData.REMARKETING_FSR.INBOUND_SEGMENT_SIZE!=null){var startIndex=clientSideData.REMARKETING_FSR.OUTBOUND_SEGMENT_SIZE+1;var endIndex=clientSideData.REMARKETING_FSR.OUTBOUND_SEGMENT_SIZE+clientSideData.REMARKETING_FSR.INBOUND_SEGMENT_SIZE;fsrDataStructure["flights"][1]=this.buildFSRFlightData(startIndex,endIndex,totalQuantityData,2);exBagIsPiecesInBound=totalQuantityData["exBagIsPieces"];}else{exBagIsPiecesInBound=exBagIsPiecesOutBound;}fsrDataStructure["ancillaryTotalAmount"]=totalQuantityData["ancillaryTotal"];fsrDataStructure["recordLocator"]=clientSideData.REMARKETING_FSR.REC_LOC;fsrDataStructure["userGeoLocation"]=clientSideData.REMARKETING_FSR.USER_GEO_LOCATION;fsrDataStructure["totalChargeableSeats"]=totalQuantityData["seatTotalQuantity"];if(exBagIsPiecesOutBound==exBagIsPiecesInBound){fsrDataStructure["totalExtraBags"]=totalQuantityData["xBagTotalQuantity"];if(exBagIsPiecesOutBound){fsrDataStructure["totalExtraBagsType"]="pieces";}else{fsrDataStructure["totalExtraBagsType"]="kg";}}this.addExactTargetRemarketingData(fsrDataStructure);return fsrDataStructure;};RemarketingManager.prototype.buildFSRFlightData=function(startIndex,endIndex,totalQuantityData,flightId){var fsrForm=$("#FSR_FORM");var flightsTempData={flightId:0,extraBags:{amount:123.12,requests:[]},segments:[]};var seatCount=0;var baggabeCount=0;var exBagBoundTotalPrice=0;var SegmentId=1;var seatQuantity=0;var xBagQuantity=0;var exBagIsPieces=true;var totalSeat=0;for(var segmentLoopId=startIndex;segmentLoopId<=endIndex;segmentLoopId++){seatCount=0;var segmentsTempData={segmentId:1,chargeableSeats:{requests:[]}};var segmentNotEmpty=false;for(var passengerLoopId=1;passengerLoopId<=clientSideData.REMARKETING.NUMBER_OF_ADT_AND_CHD;passengerLoopId++){var isChargedSeat=fsrForm.find("input[name^='WDS_SEAT_IS_CHARGEABLE_"+passengerLoopId+"_"+segmentLoopId+"_']").val();if(isChargedSeat!=null&&isChargedSeat=="TRUE"){segmentsTempData["segmentId"]=SegmentId;var requestsSeatTempData={};requestsSeatTempData["passengerId"]=passengerLoopId;var seatPrice=theUtils.getLocalIndependetAmount(fsrForm.find("input[name^='SEATPRICE_"+passengerLoopId+"_"+segmentLoopId+"_']").val());requestsSeatTempData["amount"]=seatPrice;totalSeat=totalSeat+parseFloat(seatPrice);segmentsTempData["chargeableSeats"]["requests"][seatCount]=requestsSeatTempData;seatCount++;seatQuantity++;segmentNotEmpty=true;}if(segmentLoopId==startIndex){var exBag=fsrForm.find("input[name^='WDS_XBAG_PIECE_"+passengerLoopId+"_"+startIndex+"_']").val();if(exBag==null){exBag=fsrForm.find("input[name^='WDS_XBAG_WEIGHT_"+passengerLoopId+"_"+startIndex+"_']").val();exBagIsPieces=false;}if(exBag!=null&&exBag!=""){var requestsBagsTempData={};requestsBagsTempData["passengerId"]=passengerLoopId;requestsBagsTempData["quantity"]=exBag;xBagQuantity=xBagQuantity+parseInt(exBag);if(exBagIsPieces){requestsBagsTempData["type"]="pieces";}else{requestsBagsTempData["type"]="kg";}flightsTempData["extraBags"]["requests"][baggabeCount]=requestsBagsTempData;baggabeCount++;}var boundIndex=flightId-1;if(fsrForm.find("input[name^='XBAGPRICE_"+passengerLoopId+"_"+boundIndex+"']").val()!="NaN"){exBagBoundTotalPrice=exBagBoundTotalPrice+parseFloat(fsrForm.find("input[name^='XBAGPRICE_"+passengerLoopId+"_"+boundIndex+"']").val());}}}if(segmentNotEmpty){flightsTempData["segments"][SegmentId-1]=segmentsTempData;SegmentId++;}else{segmentsTempData={segmentId:SegmentId,chargeableSeats:{requests:[]}};flightsTempData["segments"][SegmentId-1]=segmentsTempData;SegmentId++;}}flightsTempData["flightId"]=flightId;if(isNaN(exBagBoundTotalPrice)){exBagBoundTotalPrice=0;}flightsTempData["extraBags"]["amount"]=exBagBoundTotalPrice.toFixed(2);var totalAncillary=parseFloat(totalQuantityData["ancillaryTotal"])+totalSeat+exBagBoundTotalPrice;totalQuantityData["ancillaryTotal"]=totalAncillary.toFixed(2);totalQuantityData["seatTotalQuantity"]=totalQuantityData["seatTotalQuantity"]+seatQuantity;totalQuantityData["xBagTotalQuantity"]=totalQuantityData["xBagTotalQuantity"]+xBagQuantity;totalQuantityData["exBagIsPieces"]=exBagIsPieces;return flightsTempData;};RemarketingManager.prototype.sendPaymentDataOnPageLoad=function(){var purcRemarketingData=clientSideData["REMARKETING_PURF"];this.addExactTargetRemarketingData(purcRemarketingData);var remarketingDataSerialysedInJson=this.buildRemarketingData("PURF",purcRemarketingData);this.callExactTarget(JSON.parse(remarketingDataSerialysedInJson));};RemarketingManager.prototype.sendConfirmationDataOnPageLoad=function(){var confRemarketingData=clientSideData["REMARKETING_CONF"];this.addExactTargetRemarketingData(confRemarketingData);var remarketingDataSerialysedInJson=this.buildRemarketingData("CONF",confRemarketingData);this.callExactTarget(JSON.parse(remarketingDataSerialysedInJson));};window.remarketingManager=new RemarketingManager();