function FlightFilterSearchPage(){this.init();}FlightFilterSearchPage.prototype.init=function(){this.initEventHandlers();this.prepFiltering();this.nbDisplayedRowsAfterFilter;};FlightFilterSearchPage.prototype.flightTableDataExtractionFunc=function(node){var cell=$(node);var tr=cell.parent("tr");if(tr.hasClass("details")||tr.hasClass("stopDuration")||tr.hasClass("totalDurationRow")){return undefined;}if(cell.hasClass("fromTh")&&!tr.hasClass("totalDurationRow")&&!tr.hasClass("flightNextSegment")){return cell.data("cellValue");}if(cell.hasClass("toTh")&&!tr.hasClass("flightNextSegment")){if(tr.hasClass("flightType-Direct")){return cell.data("cellValue");}else{var toConnection=tr.nextUntil(".totalDurationRow").last();return toConnection.find(".toTh").data("cellValue");}}if(cell.hasClass("flightNumber")&&!tr.hasClass("flightNextSegment")){return cell.data("segmentLength");}if(cell.hasClass("durationTh")&&!tr.hasClass("flightNextSegment")){return cell.data("cellValue");}if(cell.hasClass("destiantionTh")&&!tr.hasClass("flightNextSegment")){if(tr.hasClass("flightType-Direct")){return tr.data("arrivalairportcode");}else{var toConnection=tr.nextUntil(".totalDurationRow").last();return toConnection.data("arrivalairportcode");}}return undefined;};FlightFilterSearchPage.prototype.filterFlightDetailsStart=function(table){table.data("flightDetailsOnlyLastVisible",(table.find("tr.details:not(.last)").filter(":visible").length>0)?false:true);table.find("tr.details").addClass("none");};FlightFilterSearchPage.prototype.handleBlankRowDisplay=function(table,totalFFLength){table.find("tbody tr.blankRow").remove();table.find("tbody tr").each(function(){var nextTableFlightRow=$(this).next();while(typeof nextTableFlightRow!="undefined"&&nextTableFlightRow.is("tr")&&(nextTableFlightRow.hasClass("flightNextSegment")||nextTableFlightRow.hasClass("details"))){return;}while(typeof nextTableFlightRow!="undefined"&&nextTableFlightRow.is("tr")&&nextTableFlightRow.css("display")=="none"){return;}$(this).after('<tr class="blankRow tbl-spacer"><td colspan='+totalFFLength+4+"></td> </tr>");});};FlightFilterSearchPage.prototype.prepFiltering=function(){var self=this;$("[id$=_list_flight]").tablefilter({textExtraction:this.flightTableDataExtractionFunc,selectorHeaders:"thead th",cssChildRow:"flightNextSegment"}).on("filteringStart",function(){var noneSection=$("#noBoundTemplate");var table=$(this);if(!table.find("tbody").hasClass("none")&&(table.parent().find(".noBoundTemplateClass").size()==0)){table.after(noneSection.clone().find("div").addClass("noBoundTemplateClass").parent().removeClass("none").html());}table.addClass("none").find(".details").remove();table.find("tbody tr.blankRow").remove();self.filterFlightDetailsStart(table);}).on("filteringEnd",function(e,nbDisplayedRowsAfterFilter){var table=$(this);table.removeClass("none");self.nbDisplayedRowsAfterFilter=nbDisplayedRowsAfterFilter;$(".noBoundTemplateClass").remove();});};FlightFilterSearchPage.prototype.initEventHandlers=function(){var self=this;var $document=$(document);var destinationColumnIndex=$("table.bound:first th.family").length+5;var constraintArrayForFiltering=[];$document.on("customFlightsFilter",function(event,boundType,data){self.boundNumber=boundType;var table=$("#outbound_list_flight");if(boundType!=0){table=$("#inbound_list_flight");}constraintArrayForFiltering=[];var i=0;if(data.departure[0]!=null){constraintArrayForFiltering[i]=self.buildConstraintList(0,"gte",data.departure[0]);i++;}if(data.departure[1]!=null){constraintArrayForFiltering[i]=self.buildConstraintList(0,"lte",data.departure[1]);i++;}if(data.arrival[0]!=null){constraintArrayForFiltering[i]=self.buildConstraintList(1,"gte",data.arrival[0]);i++;}if(data.arrival[1]!=null){constraintArrayForFiltering[i]=self.buildConstraintList(1,"lte",data.arrival[1]);i++;}if(data.stops!=null&&data.stops.length>0){for(var k=0;k<data.stops.length;k++){if(data.stops[k]==2){constraintArrayForFiltering[i]=self.buildConstraintList(2,"lt",data.stops[k]+1);i++;}else{constraintArrayForFiltering[i]=self.buildConstraintList(2,"neq",data.stops[k]+1);i++;}}}else{constraintArrayForFiltering[i]=self.buildConstraintList(2,"gte",0);i++;}if(data.duration!=null){constraintArrayForFiltering[i]=self.buildConstraintList(3,"lte",data.duration);i++;}if(data.destinations!=null&&data.destinations.length>0){for(var k=0;k<data.destinations.length;k++){constraintArrayForFiltering[i]=self.buildConstraintList(destinationColumnIndex,"neq",data.destinations[k]);i++;}}else{constraintArrayForFiltering[i]=self.buildConstraintList(destinationColumnIndex,"neq","");i++;}if(constraintArrayForFiltering!=null){table.trigger("filter",[constraintArrayForFiltering]);var nbDisplayedRowsToRemove=self.priceFilterOnRecommendations(table,data.price,table.find("thead th.family").length);$(document).trigger("customFilterComplete",[self.nbDisplayedRowsAfterFilter-nbDisplayedRowsToRemove,self.boundNumber]);}});};FlightFilterSearchPage.prototype.priceFilterOnRecommendations=function(table,priceFilter,totalFFlength){var nbDisplayedRowsToRemove=0;var newLowestPrice=0;var lowPriceCounter=0;var toBeClickedNode;table.find("tr").each(function(){var tr=$(this);if(tr.hasClass("sticky-header-row")||tr.hasClass("details")||tr.hasClass("stopDuration")||tr.hasClass("totalDurationRow")){return undefined;}var cells=tr[0].cells;var numberOfDisabledRecommendationsInThisTr=0;for(var f=0;f<totalFFlength;f++){var node=cells[f+4];if($(node).hasClass("ff")&&!tr.hasClass("flightNextSegment")){if($(node).hasClass("disabled")&&!$(node).hasClass("greyout")){numberOfDisabledRecommendationsInThisTr++;}else{var cellPriceRecommendation=$(node).data("cellValue");if(cellPriceRecommendation>=priceFilter[0]&&cellPriceRecommendation<=priceFilter[1]){if($(node).hasClass("noselect")){$(node).removeClass("noselect");$(node).removeClass("disabled greyout");$(node).addClass("rightE");}if($(node).css("display")!="none"){if(lowPriceCounter==0){newLowestPrice=+cellPriceRecommendation;toBeClickedNode=node;lowPriceCounter++;}if(+cellPriceRecommendation<newLowestPrice){newLowestPrice=+cellPriceRecommendation;toBeClickedNode=node;}}}else{numberOfDisabledRecommendationsInThisTr++;if(!$(node).hasClass("noselect")){$(node).addClass("noselect");$(node).addClass("disabled greyout");$(node).removeClass("rightE");}}}}}if(numberOfDisabledRecommendationsInThisTr==totalFFlength){if(tr.css("display")!="none"){nbDisplayedRowsToRemove++;tr.css("display","none");var nextTableFlightRow=tr.next();while(typeof nextTableFlightRow!="undefined"&&nextTableFlightRow.is("tr")&&(nextTableFlightRow.hasClass("flightNextSegment")||nextTableFlightRow.hasClass("details"))){nextTableFlightRow.css("display","none");nextTableFlightRow=nextTableFlightRow.next();}}}});$(toBeClickedNode).trigger("click");this.handleBlankRowDisplay(table,totalFFlength);return nbDisplayedRowsToRemove;};FlightFilterSearchPage.prototype.buildConstraintList=function(contraintColumnIndex,contraintType,constraintData){var contraintList={};contraintList["columnIndex"]=contraintColumnIndex;contraintList["type"]=contraintType;contraintList["value"]=constraintData;return contraintList;};$(document).ready(function(){window.flightFilterSearchPage=new FlightFilterSearchPage();});